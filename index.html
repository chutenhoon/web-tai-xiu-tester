<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Salon de Jeux - Luxury Casino</title>
    <meta property="og:title" content="Salon de Jeux - Luxury Casino">
    <meta property="og:description" content="Play for glory, not for money.">
    <meta property="og:image" content="anh-bia.png">
    <meta property="og:type" content="website">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Cormorant+Garamond:ital,wght@0,300;0,400;0,600;0,700;1,400&family=Manrope:wght@300;400;500;700&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        :root {
            --color-bg: #0A0A0C;
            --color-gold: #D1B27C;
            --color-gold-dim: #8a734b;
            --color-white: #F8F5EF;
            --color-grey: #1B1B1E;
            --color-violet-chrome: #6D597A; 
            --color-violet-light: #B56576;
            --font-serif: 'Cormorant Garamond', serif;
            --font-sans: 'Manrope', sans-serif;
            --ease-lux: cubic-bezier(0.22, 1, 0.36, 1);
        }

        body {
            background-color: var(--color-bg);
            color: var(--color-white);
            font-family: var(--font-sans);
            overflow: hidden;
            background-image: radial-gradient(circle at 50% 50%, #1a1a1e 0%, #0a0a0c 80%);
            -webkit-tap-highlight-color: transparent;
        }

        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        .font-serif { font-family: var(--font-serif); }
        .font-sans { font-family: var(--font-sans); }
        .text-gold { color: var(--color-gold); }
        .text-ivory { color: var(--color-white); }
        
        .deepglass {
            background: rgba(27, 27, 30, 0.7);
            backdrop-filter: blur(25px);
            -webkit-backdrop-filter: blur(25px);
            border: 1px solid rgba(209, 178, 124, 0.1);
            box-shadow: 0 20px 50px rgba(0,0,0,0.6);
        }

        .btn-lux {
            border: 1px solid var(--color-gold);
            color: var(--color-gold);
            background: transparent;
            font-family: var(--font-sans);
            letter-spacing: 0.1em;
            text-transform: uppercase;
            padding: 10px 24px;
            font-size: 0.8rem;
            transition: all 0.4s var(--ease-lux);
            cursor: pointer;
            position: relative;
            overflow: hidden;
        }
        .btn-lux:hover:not(:disabled) {
            background: rgba(209, 178, 124, 0.15);
            box-shadow: 0 0 20px rgba(209, 178, 124, 0.25);
            transform: translateY(-1px);
        }
        .btn-lux:active:not(:disabled) { transform: scale(0.98); }
        .btn-lux:disabled { opacity: 0.3; cursor: not-allowed; border-color: #555; color: #555; }

        .btn-pill { border-radius: 9999px; }
        .btn-selected {
            background: var(--color-gold) !important;
            color: var(--color-bg) !important;
            font-weight: 700;
            box-shadow: 0 0 20px rgba(209, 178, 124, 0.5);
        }

        input.input-lux {
            background: rgba(255,255,255,0.03);
            border: none;
            border-bottom: 1px solid var(--color-gold-dim);
            color: var(--color-gold);
            font-family: var(--font-serif);
            font-size: 1.5rem;
            text-align: center;
            outline: none;
            transition: 0.3s;
            width: 100%;
            padding: 10px;
        }
        input.input-lux:focus { border-color: var(--color-gold); background: rgba(255,255,255,0.05); }
        input[type=number]::-webkit-inner-spin-button, 
        input[type=number]::-webkit-outer-spin-button { -webkit-appearance: none; margin: 0; }

        .view-section {
            position: absolute; inset: 0; opacity: 0; visibility: hidden;
            transition: opacity 0.5s var(--ease-lux), transform 0.5s var(--ease-lux);
            display: flex; flex-direction: column;
            transform: scale(1.05); pointer-events: none;
        }
        .view-section.active { opacity: 1; visibility: visible; transform: scale(1); pointer-events: auto; }

        .game-card {
            background: linear-gradient(180deg, rgba(255,255,255,0.03) 0%, rgba(255,255,255,0.01) 100%);
            border: 1px solid rgba(255,255,255,0.05);
            transition: all 0.5s var(--ease-lux);
            position: relative; overflow: hidden;
        }
        .game-card:hover {
            border-color: var(--color-gold);
            box-shadow: 0 0 30px rgba(209, 178, 124, 0.2);
            transform: translateY(-5px);
        }
        .game-card::before {
            content: ''; position: absolute; top: -50%; left: -50%; width: 200%; height: 200%;
            background: radial-gradient(circle, rgba(209,178,124,0.1) 0%, transparent 60%);
            opacity: 0; transition: opacity 0.5s; pointer-events: none;
        }
        .game-card:hover::before { opacity: 1; }

        @keyframes shake {
            0% { transform: rotate(0deg); } 25% { transform: rotate(5deg); }
            50% { transform: rotate(-5deg); } 75% { transform: rotate(5deg); } 100% { transform: rotate(0deg); }
        }
        .shaking { animation: shake 0.4s infinite; }
        
        .die {
            width: 50px; height: 50px; background: #F8F5EF; border-radius: 8px;
            box-shadow: inset 0 0 5px rgba(0,0,0,0.2), 0 5px 10px rgba(0,0,0,0.3);
            display: grid; grid-template-columns: repeat(3, 1fr); padding: 6px; gap: 2px;
        }
        .dot { background: #1a1a1a; border-radius: 50%; width: 8px; height: 8px; align-self: center; justify-self: center; visibility: hidden; }
        .die[data-val="1"] .d5, .die[data-val="2"] .d1, .die[data-val="2"] .d9, .die[data-val="3"] .d1, .die[data-val="3"] .d5, .die[data-val="3"] .d9,
        .die[data-val="4"] .d1, .die[data-val="4"] .d3, .die[data-val="4"] .d7, .die[data-val="4"] .d9,
        .die[data-val="5"] .d1, .die[data-val="5"] .d3, .die[data-val="5"] .d5, .die[data-val="5"] .d7, .die[data-val="5"] .d9,
        .die[data-val="6"] .d1, .die[data-val="6"] .d3, .die[data-val="6"] .d4, .die[data-val="6"] .d6, .die[data-val="6"] .d7, .die[data-val="6"] .d9 { visibility: visible; }
        .die[data-val="1"] .d5 { background: #800020; transform: scale(1.4); }

        .card-bj {
            width: 64px; height: 90px; 
            background: #F4F1EA; border: 1px solid #999; border-radius: 6px;
            display: flex; flex-direction: column; justify-content: space-between; padding: 5px;
            font-family: var(--font-serif); position: relative;
            box-shadow: -2px 4px 12px rgba(0,0,0,0.4); transition: transform 0.3s; font-weight: 700;
        }
        .card-bj.red { color: #D00000; } 
        .card-bj.black { color: #111; }
        .card-bj.gold-border { border: 2px solid var(--color-gold); background: #FFFDF8; }
        .card-back { 
            background: repeating-linear-gradient(45deg, #2A2A2E, #2A2A2E 10px, #1A1A1E 10px, #1A1A1E 20px); 
            border: 2px solid #555; box-shadow: inset 0 0 10px rgba(0,0,0,0.8);
        }
        .card-value-lg { 
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); 
            font-size: 2rem; opacity: 0.15; 
        }
        .card-top-val { font-size: 0.9rem; line-height: 1; }
        .deal-anim { animation: dealCard 0.4s ease-out forwards; opacity: 0; transform: translateY(-50px); }
        @keyframes dealCard { to { opacity: 1; transform: translateY(0); } }

        .slot-body {
            background: linear-gradient(135deg, #2a1b3d 0%, #000000 100%);
            border: 2px solid var(--color-violet-chrome);
            box-shadow: 0 0 30px rgba(109, 89, 122, 0.3), inset 0 0 20px rgba(0,0,0,0.8);
            border-radius: 12px; padding: 20px; position: relative;
            transform-style: preserve-3d; perspective: 1000px;
        }
        .slot-body::before {
            content: ''; position: absolute; inset: -2px; z-index: -1;
            background: linear-gradient(45deg, transparent, rgba(209, 178, 124, 0.3), transparent); filter: blur(5px);
        }
        .reel-container {
            display: flex; gap: 10px; justify-content: center;
            background: #111; padding: 10px; border-radius: 6px;
            box-shadow: inset 0 0 10px rgba(0,0,0,0.9); border: 1px solid #333;
        }
        .reel-window {
            width: 70px; height: 120px;
            background: linear-gradient(to right, #e0e0e0 0%, #F8F5EF 50%, #d6d6d6 100%);
            border-radius: 4px; overflow: hidden; position: relative;
            box-shadow: inset 0 0 15px rgba(0,0,0,0.4); border: 1px solid #000;
        }
        .reel-window::after {
            content: ''; position: absolute; inset: 0;
            background: linear-gradient(180deg, rgba(0,0,0,0.7) 0%, transparent 20%, transparent 80%, rgba(0,0,0,0.7) 100%);
            pointer-events: none; z-index: 10;
        }
        .reel-strip {
            display: flex; flex-direction: column; align-items: center;
            transition: transform 0.1s linear; will-change: transform;
        }
        .reel-symbol {
            height: 120px; display: flex; align-items: center; justify-content: center;
            font-size: 3.5rem; width: 100%; text-shadow: 1px 1px 2px rgba(0,0,0,0.2);
        }
        .symbol-7 { font-family: var(--font-serif); color: #6D597A; font-weight: 700; }
        .symbol-bell { filter: sepia(0.6); }
        .symbol-star { filter: sepia(0.3) hue-rotate(-10deg); }
        .symbol-diamond { filter: drop-shadow(0 0 5px cyan); }
        .symbol-crown { filter: drop-shadow(0 0 5px gold); }
        .win-line {
            position: absolute; top: 50%; left: 5%; right: 5%; height: 2px;
            background: rgba(209, 178, 124, 0.5); z-index: 20; box-shadow: 0 0 5px var(--color-gold);
            display: none;
        }

        .rank-row { border-bottom: 1px solid rgba(255,255,255,0.05); }
        .rank-row:last-child { border: none; }
        .btn-preset {
            background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1);
            color: #888; border-radius: 4px; padding: 6px 0; font-size: 0.7rem; transition: 0.2s;
        }
        .btn-preset:hover { border-color: var(--color-gold); color: var(--color-gold); background: rgba(209,178,124,0.1); }
        .btn-preset:active { transform: scale(0.95); }

        .calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 4px; }
        .cal-day {
            aspect-ratio: 1; border-radius: 4px; font-size: 0.6rem; display: flex; align-items: center; justify-content: center;
            background: rgba(255,255,255,0.03); color: #444; position: relative;
        }
        .cal-day.win { background: rgba(34, 197, 94, 0.15); color: #4ade80; border: 1px solid rgba(34,197,94,0.2); }
        .cal-day.loss { background: rgba(239, 68, 68, 0.15); color: #f87171; border: 1px solid rgba(239,68,68,0.2); }
        .cal-day.today { border: 1px solid var(--color-gold); box-shadow: 0 0 5px rgba(209,178,124,0.3); }

        #fx-canvas { position: absolute; inset: 0; pointer-events: none; z-index: 9999; }
        #fx-overlay { position: absolute; inset: 0; pointer-events: none; z-index: 9998; display: flex; align-items: center; justify-content: center; overflow: hidden; }
        .fx-screen-shake { animation: screenShake 0.5s cubic-bezier(.36,.07,.19,.97) both; }
        .fx-flash-red { animation: redFlash 0.6s ease-out forwards; }
        .fx-flash-gold { animation: goldFlash 0.8s ease-out forwards; }

        .float-text {
            position: absolute; font-family: var(--font-serif); font-weight: bold; font-size: 4rem;
            animation: floatUp 1.5s ease-out forwards; text-shadow: 0 4px 10px rgba(0,0,0,0.5);
            pointer-events: none; z-index: 10000;
        }

        @keyframes screenShake {
            10%, 90% { transform: translate3d(-2px, 0, 0) rotate(-1deg); }
            20%, 80% { transform: translate3d(4px, 0, 0) rotate(2deg); }
            30%, 50%, 70% { transform: translate3d(-6px, 0, 0) rotate(-2deg); }
            40%, 60% { transform: translate3d(6px, 0, 0) rotate(1deg); }
        }
        @keyframes redFlash {
            0% { background: rgba(180, 20, 20, 0); }
            10% { background: rgba(180, 20, 20, 0.4); box-shadow: inset 0 0 100px rgba(0,0,0,0.8); }
            100% { background: rgba(180, 20, 20, 0); }
        }
        @keyframes goldFlash {
            0% { background: rgba(209, 178, 124, 0); }
            20% { background: rgba(209, 178, 124, 0.3); box-shadow: inset 0 0 60px rgba(255,215,0,0.5); }
            100% { background: rgba(209, 178, 124, 0); }
        }
        @keyframes floatUp {
            0% { transform: translateY(50px) scale(0.5); opacity: 0; }
            20% { transform: translateY(0) scale(1.2); opacity: 1; }
            100% { transform: translateY(-100px) scale(1); opacity: 0; }
        }

        .avatar-btn {
            width: 40px; height: 40px; border-radius: 50%;
            background: linear-gradient(135deg, #1a1a1e, #0A0A0C);
            border: 1px solid rgba(209, 178, 124, 0.3);
            display: flex; align-items: center; justify-content: center;
            cursor: pointer; transition: 0.3s;
        }
        .avatar-btn:hover { border-color: var(--color-gold); box-shadow: 0 0 10px rgba(209,178,124,0.2); transform: scale(1.05); }

        .chat-box { height: 150px; overflow-y: auto; background: rgba(0,0,0,0.3); border-radius: 4px; padding: 8px; margin-bottom: 8px; font-size: 0.7rem; border: 1px solid rgba(255,255,255,0.05); }
        .chat-msg { margin-bottom: 4px; word-wrap: break-word; }
        .chat-msg span { font-weight: bold; margin-right: 4px; }
        .player-seat { display: flex; flex-direction: column; align-items: center; justify-content: center; opacity: 0.5; transition: 0.3s; }
        .player-seat.active { opacity: 1; }
        
        .bubble-pop { animation: bubblePop 0.3s ease-out; }
        @keyframes bubblePop { 0% { transform: scale(0.5); opacity: 0; } 80% { transform: scale(1.1); } 100% { transform: scale(1); opacity: 1; } }

        .feed-item {
            animation: slideInLeft 0.5s ease-out;
            border-bottom: 1px solid rgba(255,255,255,0.05);
        }
        .feed-item:last-child { border-bottom: none; }
        @keyframes slideInLeft {
            from { opacity: 0; transform: translateX(-20px); }
            to { opacity: 1; transform: translateX(0); }
        }

        .sound-icon-game {
            width: 32px; height: 32px;
            display: flex; align-items: center; justify-content: center;
            border-radius: 50%; border: 1px solid rgba(255,255,255,0.1);
            color: #666; cursor: pointer; transition: all 0.2s;
        }
        .sound-icon-game:hover { color: var(--color-gold); border-color: var(--color-gold); background: rgba(209,178,124,0.1); }
        .sound-icon-game.muted { color: #333; border-color: rgba(255,255,255,0.05); }

        .bill-overlay {
            position: fixed; inset: 0; z-index: 100000;
            background: rgba(0,0,0,0.9);
            display: flex; align-items: center; justify-content: center;
            opacity: 0; pointer-events: none; transition: 0.3s;
            backdrop-filter: blur(5px);
        }
        .bill-overlay.active { opacity: 1; pointer-events: auto; }
        .bill-paper {
            width: 95%; max-width: 600px;
            background: #0f0f11;
            border: 1px solid rgba(255,255,255,0.1);
            padding: 40px 30px;
            box-shadow: 0 25px 80px rgba(0,0,0,0.8);
            position: relative;
            transform: scale(0.95); transition: 0.4s cubic-bezier(0.16, 1, 0.3, 1);
            display: flex; flex-direction: column;
            border-radius: 16px;
        }
        .bill-overlay.active .bill-paper { transform: scale(1); }
        .bill-row { display: flex; justify-content: space-between; margin-bottom: 20px; font-size: 1rem; border-bottom: 1px solid rgba(255,255,255,0.03); padding-bottom: 12px; align-items: baseline; }
        .bill-row:last-of-type { border-bottom: none; margin-bottom: 0; }
        .bill-row span:last-child { color: #e5e7eb; text-align: right; font-family: var(--font-mono); font-size: 1rem; max-width: 65%; word-break: break-word; font-weight: 500; }
        .bill-row span:first-child { color: #6b7280; text-transform: uppercase; font-size: 0.75rem; letter-spacing: 1.5px; flex-shrink: 0; font-weight: 600; }
        .stamp {
            position: absolute; bottom: 40px; right: 40px;
            width: 110px; height: 110px; border: 4px solid #D00000; border-radius: 50%;
            color: #D00000; display: flex; align-items: center; justify-content: center;
            font-weight: 900; opacity: 0.8; transform: rotate(-15deg); font-family: 'Courier New', Courier, monospace;
            font-size: 1.6rem; letter-spacing: 2px; text-transform: uppercase;
        }
        
        .trade-btn-sm {
            background: rgba(255,255,255,0.05);
            border: 1px solid rgba(255,255,255,0.1);
            border-radius: 4px;
            color: #888;
            font-size: 0.65rem;
            padding: 6px 4px;
            transition: 0.2s;
            text-transform: uppercase;
            font-weight: bold;
        }
        .trade-btn-sm:hover { border-color: var(--color-gold); color: var(--color-gold); background: rgba(209,178,124,0.1); }
        .trade-btn-sm:active { transform: scale(0.95); }
        
        .btn-leverage.active { border-color: var(--color-gold); color: var(--color-gold); background: rgba(209,178,124,0.1); }
        .btn-time.active { background: rgba(255,255,255,0.1); border-color: white; color: white; }
        
        #app.full-screen-mode {
            max-width: 100% !important;
            width: 100% !important;
            height: 100dvh !important;
            border-radius: 0;
        }
        #tradeChart { cursor: crosshair; touch-action: none; }
        @media (min-width: 1024px) {
             #view-trading .flex-col {
                max-width: 100% !important;
             }
        }
    </style>
</head>
<body>

    <div id="app" class="relative w-full h-[100dvh] max-w-md mx-auto shadow-2xl overflow-hidden bg-black/50 transition-all duration-200">
        <canvas id="fx-canvas"></canvas>
        <div id="fx-overlay"></div>
        <div id="particles" class="absolute inset-0 pointer-events-none z-0"></div>
        
        <div id="bill-modal" class="bill-overlay">
            <div class="bill-paper">
                <div class="text-center mb-10">
                    <div class="w-12 h-12 bg-white/5 rounded-full flex items-center justify-center mx-auto mb-4 border border-white/10">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="#D1B27C" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="20 6 9 17 4 12"></polyline></svg>
                    </div>
                    <h2 class="font-serif text-3xl text-white mb-1 tracking-wide">Giao Dịch Thành Công</h2>
                    <p class="text-[11px] text-gray-500 uppercase tracking-widest font-sans">Digital Receipt</p>
                </div>
                
                <div class="space-y-2 font-sans flex-1 mb-10 px-2">
                    <div class="bg-white/5 rounded-lg p-6 mb-6 text-center border border-white/5">
                        <p class="text-xs text-gray-400 uppercase tracking-widest mb-2">Số Tiền Giao Dịch</p>
                        <span id="bill-amount" class="text-4xl font-bold text-white font-serif block">$ 0</span>
                    </div>

                    <div class="bill-row"><span>Mã Giao Dịch</span><span id="bill-id" class="text-gold">#---</span></div>
                    <div class="bill-row"><span>Thời Gian</span><span id="bill-date">--:--</span></div>
                    <div class="bill-row"><span>Người Gửi</span><span id="bill-sender">---</span></div>
                    <div class="bill-row"><span>Người Nhận</span><span id="bill-receiver">---</span></div>
                    <div class="bill-row"><span>Trạng Thái</span><span class="text-green-500">Hoàn thành</span></div>
                </div>
                
                <button onclick="document.getElementById('bill-modal').classList.remove('active')" class="w-full py-4 rounded-lg bg-white text-black font-bold text-xs uppercase tracking-widest hover:bg-gray-200 transition-colors">Đóng biên lai</button>
            </div>
        </div>

        <section id="view-intro" class="view-section active z-50">
            <div class="w-full h-full flex flex-col items-center justify-center p-8">
                <div class="mb-12 text-center animate-fade-in">
                    <h1 class="font-serif text-5xl italic text-gold tracking-wide">Salon de Jeux</h1>
                    <p class="font-sans text-xs text-gray-500 mt-2 uppercase tracking-widest">Play for glory, not for money</p>
                </div>

                <div class="deepglass p-8 rounded-sm w-full max-w-xs transform transition-all">
                    <p class="font-serif text-xl text-ivory mb-6 italic text-center">"Bienvenue."</p>
                    <div class="space-y-4 mb-4">
                        <div><input type="text" id="inp-name" class="input-lux" placeholder="Tên đăng nhập..." autocomplete="off"></div>
                        <div><input type="password" id="inp-pass" class="input-lux" placeholder="Mật khẩu..." autocomplete="off"></div>
                    </div>
                    <div class="flex gap-3">
                        <button onclick="app.auth.register()" class="btn-lux flex-1 text-xs uppercase tracking-wider">Đăng ký</button>
                        <button onclick="app.auth.login()" class="btn-lux flex-1 text-xs uppercase tracking-wider">Đăng nhập</button>
                    </div>
                </div>
            </div>
        </section>

        <section id="view-hall" class="view-section z-10">
            <div class="flex flex-col h-full p-6">
                <div class="flex justify-between items-center mb-6 pb-4 border-b border-white/10">
                    <div class="flex-1">
                        <div class="flex items-center gap-3">
                             <h2 id="dash-name" class="font-serif text-2xl text-gold italic">Guest</h2>
                        </div>
                        <div class="flex items-center gap-2 text-xs text-gray-400 mt-1">
                            <span class="uppercase tracking-widest">ID: <span id="dash-id">---</span></span>
                        </div>
                    </div>
                    <div class="flex items-center gap-3">
                         <div class="text-right mr-2">
                            <p class="text-[10px] text-gray-500 uppercase tracking-widest">Balance</p>
                            <p id="dash-score" class="font-serif text-2xl text-white">$ 0</p>
                        </div>
                        <div onclick="app.showProfile()" class="avatar-btn group">
                            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" class="text-gray-400 group-hover:text-gold transition-colors"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path><circle cx="12" cy="7" r="4"></circle></svg>
                        </div>
                    </div>
                </div>

                <div class="flex-1 overflow-y-auto space-y-4 pb-20 no-scrollbar relative">
                    <div onclick="app.gotoGame('slots')" class="game-card p-6 rounded-lg cursor-pointer group flex flex-col justify-between h-40" style="border-color: rgba(109,89,122,0.3);">
                        <div>
                            <div class="flex justify-between items-start">
                                <h3 class="font-serif text-2xl text-ivory italic group-hover:text-purple-400 transition-colors">L'Amour Slots</h3>
                                <span class="text-[10px] border border-purple-800 text-purple-300 px-2 py-0.5 rounded uppercase">New</span>
                            </div>
                            <p class="text-xs text-gray-500 mt-2 font-sans">Cổ điển • Sang trọng</p>
                        </div>
                        <div class="flex justify-end"><span class="text-purple-400 text-sm uppercase tracking-widest opacity-0 group-hover:opacity-100 transition-opacity">Tourner →</span></div>
                    </div>

                    <div onclick="app.gotoGame('taixiu')" class="game-card p-6 rounded-lg cursor-pointer group flex flex-col justify-between h-40">
                        <div>
                            <div class="flex justify-between items-start">
                                <h3 class="font-serif text-2xl text-ivory italic group-hover:text-gold transition-colors">Tài Xỉu Solo</h3>
                                <span class="text-[10px] border border-gold text-gold px-2 py-0.5 rounded uppercase">Popular</span>
                            </div>
                            <p class="text-xs text-gray-500 mt-2 font-sans">Sảnh đơn • Tích điểm nhanh</p>
                        </div>
                        <div class="flex justify-end"><span class="text-gold text-sm uppercase tracking-widest opacity-0 group-hover:opacity-100 transition-opacity">Jouer →</span></div>
                    </div>

                    <div onclick="app.gotoGame('blackjack')" class="game-card p-6 rounded-lg cursor-pointer group flex flex-col justify-between h-40">
                        <div>
                            <div class="flex justify-between items-start">
                                <h3 class="font-serif text-2xl text-ivory italic group-hover:text-gold transition-colors">Blackjack</h3>
                                <span class="text-[10px] border border-gray-700 text-gray-400 px-2 py-0.5 rounded uppercase">21 Royale</span>
                            </div>
                            <p class="text-xs text-gray-500 mt-2 font-sans">1 vs Dealer • Chiến thuật</p>
                        </div>
                        <div class="flex justify-end"><span class="text-gold text-sm uppercase tracking-widest opacity-0 group-hover:opacity-100 transition-opacity">Jouer →</span></div>
                    </div>
                    
                    <div onclick="app.gotoGame('trading')" class="game-card p-6 rounded-lg cursor-pointer group flex flex-col justify-between h-40" style="border-color: rgba(34, 197, 94, 0.2);">
                        <div>
                            <div class="flex justify-between items-start">
                                <h3 class="font-serif text-2xl text-ivory italic group-hover:text-green-400 transition-colors">Trading 30s</h3>
                                <span class="text-[10px] border border-green-800 text-green-400 px-2 py-0.5 rounded uppercase">HOT</span>
                            </div>
                            <p class="text-xs text-gray-500 mt-2 font-sans">Candles • Leverage • High Risk</p>
                        </div>
                        <div class="flex justify-end"><span class="text-green-400 text-sm uppercase tracking-widest opacity-0 group-hover:opacity-100 transition-opacity">Trade →</span></div>
                    </div>

                    <div class="mt-8 mb-4">
                         <h3 class="text-[10px] text-gray-500 uppercase tracking-widest mb-3 flex items-center gap-2">
                             <span class="w-1.5 h-1.5 rounded-full bg-green-500 animate-pulse"></span>
                             Người chơi gần đây
                         </h3>
                         <div class="deepglass rounded-lg overflow-hidden">
                             <div id="live-feed-list" class="flex flex-col">
                                 <div class="p-4 text-xs text-gray-500 text-center">Đang tải dữ liệu...</div>
                             </div>
                         </div>
                    </div>
                </div>

                <div class="absolute bottom-6 left-6 right-6 flex justify-between items-center bg-[#0f0f11] p-1 rounded-full border border-white/10 shadow-lg">
                    <button onclick="app.showLeaderboard()" class="flex-1 py-3 text-center text-xs uppercase tracking-widest text-gray-400 hover:text-gold transition-colors">Classement</button>
                    <div class="w-px h-4 bg-white/10"></div>
                    <button onclick="app.logout()" class="flex-1 py-3 text-center text-xs uppercase tracking-widest text-red-900 hover:text-red-500 transition-colors">Sortie</button>
                </div>
            </div>
        </section>

        <section id="view-profile" class="view-section z-30 bg-[#0E0E10]">
             <div class="p-6 h-full flex flex-col overflow-y-auto no-scrollbar">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="font-serif text-3xl text-gold italic">Tài Khoản</h2>
                    <button onclick="app.switchView('view-hall')" class="text-gray-500 hover:text-white text-2xl">&times;</button>
                </div>
                
                <div class="flex gap-2 mb-6 border-b border-white/10 pb-1">
                    <button onclick="app.profile.switchTab('bank')" id="pf-tab-bank" class="flex-1 py-2 text-xs uppercase tracking-wider text-gold font-bold border-b-2 border-gold">Ngân Hàng</button>
                    <button onclick="app.profile.switchTab('perf')" id="pf-tab-perf" class="flex-1 py-2 text-xs uppercase tracking-wider text-gray-500">Hiệu Suất</button>
                </div>

                <div id="pf-content-bank" class="space-y-6">
                    <div class="deepglass p-6 rounded-lg relative overflow-hidden">
                        <div class="absolute -top-10 -right-10 w-32 h-32 bg-gold/10 rounded-full blur-2xl"></div>
                        <p class="text-[10px] text-gray-400 uppercase tracking-widest mb-1">Số Dư Khả Dụng</p>
                        <p id="bank-balance" class="text-3xl font-serif text-white">$ 0</p>
                    </div>

                    <div class="space-y-4">
                         <h3 class="text-xs text-gold uppercase tracking-widest">Chuyển Tiền</h3>
                         <div class="space-y-3">
                             <div class="relative">
                                 <input type="text" id="tx-receiver" class="input-lux text-left text-sm" placeholder="Nhập ID hoặc Tên người nhận">
                                 <div id="rx-check-loading" class="absolute right-2 top-3 hidden"><div class="w-4 h-4 border-2 border-gold border-t-transparent rounded-full animate-spin"></div></div>
                             </div>
                             <div>
                                 <input type="number" id="tx-amount" class="input-lux text-left text-sm" placeholder="Số tiền (USD)">
                             </div>
                             <div id="rx-preview" class="text-xs text-gray-400 italic h-4 pl-2"></div>
                             <button onclick="app.profile.sendMoney()" class="btn-lux w-full bg-gold/10 border-gold text-gold font-bold hover:bg-gold/20">XÁC NHẬN CHUYỂN</button>
                         </div>
                    </div>

                    <div>
                        <h3 class="text-xs text-gray-500 uppercase tracking-widest mb-3">Lịch Sử Giao Dịch</h3>
                        <div class="h-[400px] overflow-y-auto no-scrollbar space-y-2 pb-10" id="tx-history-list">
                            <div class="p-4 text-center text-xs text-gray-600 italic">Chưa có giao dịch nào</div>
                        </div>
                    </div>
                </div>

                <div id="pf-content-perf" class="space-y-8 hidden">
                    <div class="grid grid-cols-2 gap-4">
                        <div class="deepglass p-4 rounded text-center">
                            <p class="text-[10px] text-gray-500 uppercase">Total Wins</p>
                            <p id="stat-wins" class="text-xl text-gold font-serif mt-1">0</p>
                        </div>
                         <div class="deepglass p-4 rounded text-center">
                            <p class="text-[10px] text-gray-500 uppercase">Best Win</p>
                            <p id="stat-max" class="text-xl text-white font-serif mt-1">$ 0</p>
                        </div>
                    </div>

                    <div>
                        <div class="flex justify-between items-end mb-2">
                            <h3 class="text-xs uppercase tracking-widest text-gray-500">Today's PNL</h3>
                            <span id="pnl-today-val" class="font-mono text-sm text-white">$ 0</span>
                        </div>
                        <div class="w-full h-56 bg-gradient-to-b from-white/5 to-transparent rounded-lg p-3 border border-white/5 shadow-inner">
                            <canvas id="pnlChart"></canvas>
                        </div>
                    </div>

                    <div>
                         <div class="flex justify-between items-end mb-4">
                             <h3 class="text-xs uppercase tracking-widest text-gray-500">30-Day Activity</h3>
                             <div class="flex gap-2 text-[9px] text-gray-500 uppercase">
                                 <span class="flex items-center gap-1"><div class="w-2 h-2 bg-green-500/20 border border-green-500/30 rounded-sm"></div> Win</span>
                                 <span class="flex items-center gap-1"><div class="w-2 h-2 bg-red-500/20 border border-red-500/30 rounded-sm"></div> Loss</span>
                             </div>
                         </div>
                         <div id="pnl-calendar" class="calendar-grid bg-[#121214] p-2 rounded-lg border border-white/5"></div>
                    </div>
                </div>
             </div>
        </section>

        <section id="view-trading" class="view-section z-20 bg-[#0B0B0E]">
             <div class="absolute top-4 right-4 z-30 text-right">
                <p class="text-[10px] text-gray-500 uppercase tracking-widest">Balance</p>
                <p class="text-gold font-serif text-xl user-balance-display">$ 0</p>
            </div>
            <div class="absolute top-4 left-4 z-30 flex gap-3">
                <button onclick="app.switchView('view-hall')" class="text-gold font-serif italic hover:opacity-70 text-lg">← Exit</button>
            </div>

            <div class="flex flex-col h-full pt-16 pb-4 px-4 w-full max-w-full">
                <div class="flex justify-between items-end mb-2">
                    <div>
                        <h2 class="font-serif text-2xl text-white italic">DeJeux/USD</h2>
                        <div class="flex items-center gap-2">
                            <span id="trade-price" class="font-mono text-xl font-bold text-white">54,230.50</span>
                            <span id="trade-change" class="text-xs text-green-500">+0.45%</span>
                        </div>
                    </div>
                    <div id="trade-pnl-live" class="hidden text-right">
                         <span class="text-[10px] text-gray-500 uppercase block">Live PNL</span>
                         <span id="pnl-live-val" class="font-mono text-xl font-bold text-gray-500">$ 0</span>
                    </div>
                </div>
                
                <div class="relative w-full flex-1 bg-[#151518] rounded-lg border border-white/5 mb-4 overflow-hidden min-h-[300px]">
                    <canvas id="tradeChart" class="w-full h-full"></canvas>
                    
                    <div id="trade-timer-overlay" class="absolute top-2 right-14 hidden z-10 bg-black/50 px-2 py-1 rounded backdrop-blur-sm border border-white/10">
                        <span class="text-[9px] text-gray-400 uppercase mr-2">Closing in:</span>
                        <span id="trade-countdown" class="font-mono text-gold font-bold">00:00</span>
                    </div>

                    <div id="trade-result-overlay" class="absolute inset-0 flex items-center justify-center bg-black/60 opacity-0 pointer-events-none transition-opacity duration-300 z-20">
                        <div class="text-center transform scale-90 transition-transform duration-300" id="trade-result-box">
                            <p class="text-4xl font-serif italic mb-1" id="trade-res-title">Win</p>
                            <p class="font-mono text-lg" id="trade-res-amt">+$ 100</p>
                        </div>
                    </div>
                </div>

                <div class="flex flex-col justify-end space-y-2 lg:flex-row lg:space-y-0 lg:gap-6 lg:items-end lg:bg-[#151518] lg:p-4 lg:rounded-lg lg:border lg:border-white/5">
                    <div class="grid grid-cols-2 gap-2 lg:flex-1">
                        <div class="flex flex-col gap-1">
                            <p class="text-[9px] text-gray-500 uppercase tracking-widest">Duration</p>
                            <div class="flex gap-1 bg-white/5 p-1 rounded-lg">
                                <button onclick="app.trading.setTime(10)" id="btn-time-10" class="flex-1 py-2 text-xs font-bold rounded text-gray-400 btn-time hover:text-white transition">10s</button>
                                <button onclick="app.trading.setTime(30)" id="btn-time-30" class="flex-1 py-2 text-xs font-bold rounded text-white bg-white/10 btn-time active hover:text-white transition">30s</button>
                                <button onclick="app.trading.setTime(60)" id="btn-time-60" class="flex-1 py-2 text-xs font-bold rounded text-gray-400 btn-time hover:text-white transition">60s</button>
                            </div>
                        </div>
                        <div class="flex flex-col gap-1">
                            <p class="text-[9px] text-gray-500 uppercase tracking-widest">Leverage</p>
                            <div class="flex gap-1 h-full">
                                <input type="number" id="leverage-input" class="w-14 bg-white/5 border border-white/10 rounded text-center text-gold font-bold text-sm" value="10" onchange="app.trading.setLeverage(this.value)">
                                <div class="flex-1 grid grid-cols-2 gap-1">
                                    <button onclick="app.trading.setLeverage(5)" class="trade-btn-sm">x5</button>
                                    <button onclick="app.trading.setLeverage(20)" class="trade-btn-sm">x20</button>
                                    <button onclick="app.trading.setLeverage(50)" class="trade-btn-sm">x50</button>
                                    <button onclick="app.trading.setLeverage(100)" class="trade-btn-sm">x100</button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="flex gap-2 items-end lg:flex-[2]">
                        <div class="w-1/3 lg:w-auto lg:flex-1">
                             <p class="text-[9px] text-gray-500 uppercase tracking-widest mb-1">Amount ($)</p>
                             <input type="number" id="trade-amount" class="w-full bg-white/5 border border-white/10 rounded p-3 text-center text-white font-mono outline-none focus:border-gold transition text-base font-bold" value="100">
                        </div>
                        <div class="flex-1 flex gap-2 h-[50px] lg:flex-[2]">
                            <button onclick="app.trading.placeOrder('up')" id="btn-long" class="flex-1 bg-green-500/10 border border-green-500/50 text-green-400 rounded font-bold hover:bg-green-500 hover:text-black transition shadow-[0_0_15px_rgba(74,222,128,0.1)] text-sm active:scale-95">
                                LONG
                            </button>
                            <button onclick="app.trading.placeOrder('down')" id="btn-short" class="flex-1 bg-red-500/10 border border-red-500/50 text-red-400 rounded font-bold hover:bg-red-500 hover:text-black transition shadow-[0_0_15px_rgba(248,113,113,0.1)] text-sm active:scale-95">
                                SHORT
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <section id="view-taixiu" class="view-section z-20">
            <div class="absolute top-6 right-6 z-30 text-right">
                <p class="text-[10px] text-gray-500 uppercase tracking-widest">Balance</p>
                <p class="text-gold font-serif text-xl user-balance-display">$ 0</p>
            </div>
            <div class="absolute top-6 left-6 z-30 flex gap-3">
                <button onclick="app.switchView('view-hall')" class="text-gold font-serif italic hover:opacity-70 text-lg">← Retour</button>
                <div class="sound-toggle-btn sound-icon-game" onclick="app.audio.toggle()">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"></polygon><path d="M19.07 4.93a10 10 0 0 1 0 14.14M15.54 8.46a5 5 0 0 1 0 7.07"></path></svg>
                </div>
            </div>

            <div class="w-full h-full flex flex-col items-center p-6 py-12">
                <h2 class="font-serif text-3xl text-gold italic mt-8">Solo Lounge</h2>
                <div class="text-xs text-gray-500 uppercase tracking-widest mb-10">4-10 Xỉu • 11-17 Tài • Triple Lose</div>

                <div class="relative w-full flex justify-center items-center h-32 mb-4">
                    <div id="dice-wrapper" class="flex gap-4 perspective-600">
                        <div class="die" id="die-1" data-val="1"><div class="dot d5"></div></div>
                        <div class="die" id="die-2" data-val="2"><div class="dot d1"></div><div class="dot d9"></div></div>
                        <div class="die" id="die-3" data-val="3"><div class="dot d1"></div><div class="dot d5"></div><div class="dot d9"></div></div>
                    </div>
                </div>

                <div id="tx-result" class="h-16 text-center opacity-0 transition-opacity duration-300 mb-4">
                    <p class="font-serif text-3xl text-white italic" id="tx-msg">Victoire!</p>
                    <p class="text-xs text-gray-400 font-sans mt-1 uppercase" id="tx-sub">12 Điểm • Tài</p>
                </div>

                <div class="w-full mt-auto space-y-4">
                    <div class="w-full max-w-xs mx-auto mb-4 bg-[#151517] p-3 rounded-lg border border-white/10">
                        <div class="relative mb-3">
                            <input type="number" id="tx-bet-input" class="input-lux text-center text-2xl font-bold bg-transparent border-none p-0" value="1000">
                        </div>
                        <div class="grid grid-cols-5 gap-1">
                            <button onclick="app.setBet('tx', 100)" class="btn-preset">100</button>
                            <button onclick="app.setBet('tx', 500)" class="btn-preset">500</button>
                            <button onclick="app.setBet('tx', 1000)" class="btn-preset">1K</button>
                            <button onclick="app.setBet('tx', 5000)" class="btn-preset">5K</button>
                            <button onclick="app.setBet('tx', 'ALL')" class="btn-preset text-gold border-gold/30">ALL</button>
                        </div>
                    </div>

                    <div class="flex justify-between gap-4">
                        <button id="btn-xiu" onclick="app.taixiu.select('XIU')" class="btn-lux btn-pill flex-1 border-white/20 text-white/80 hover:border-gold">XỈU <span class="block text-[9px] opacity-50 mt-1">4 — 10</span></button>
                        <button id="btn-tai" onclick="app.taixiu.select('TAI')" class="btn-lux btn-pill flex-1 border-white/20 text-white/80 hover:border-gold">TÀI <span class="block text-[9px] opacity-50 mt-1">11 — 17</span></button>
                    </div>
                    <button id="btn-tx-roll" onclick="app.taixiu.roll()" class="btn-lux w-full bg-gold/10 border-gold text-gold font-bold opacity-30 pointer-events-none transition-opacity">LANCER</button>
                </div>
            </div>
        </section>

        <section id="view-blackjack" class="view-section z-20">
            <div class="absolute top-6 right-6 z-30 text-right">
                <p class="text-[10px] text-gray-500 uppercase tracking-widest">Balance</p>
                <p class="text-gold font-serif text-xl user-balance-display">$ 0</p>
            </div>
            <div class="absolute top-6 left-6 z-30 flex gap-3">
                <button onclick="app.switchView('view-hall')" class="text-gold font-serif italic hover:opacity-70 text-lg">← Quitter</button>
                <div class="sound-toggle-btn sound-icon-game" onclick="app.audio.toggle()">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"></polygon><path d="M19.07 4.93a10 10 0 0 1 0 14.14M15.54 8.46a5 5 0 0 1 0 7.07"></path></svg>
                </div>
            </div>

            <div class="w-full h-full flex flex-col justify-between p-6 bg-[#0E0E10]">
                <div class="mt-16 text-center">
                    <div class="flex justify-center items-center gap-2 mb-2">
                        <p class="text-xs text-gray-500 uppercase tracking-widest">Dealer</p>
                        <div class="bg-white/10 px-2 py-0.5 rounded text-xs text-gray-300 font-mono opacity-0 transition-opacity" id="bj-dealer-score-box">Tổng: <span id="bj-dealer-score" class="font-bold text-white">0</span></div>
                    </div>
                    <div id="bj-dealer-cards" class="flex justify-center gap-2 h-28"></div>
                </div>

                <div class="text-center h-12 flex items-center justify-center">
                    <p id="bj-msg" class="font-serif text-3xl text-white italic transition-opacity opacity-0 shadow-black drop-shadow-lg">Blackjack!</p>
                </div>

                <div class="mb-4 text-center">
                    <div class="flex justify-center items-center gap-2 mb-2">
                         <div class="bg-gold/20 border border-gold/30 px-3 py-1 rounded text-sm text-gold font-mono">Tổng: <span id="bj-player-score" class="font-bold text-xl">0</span></div>
                    </div>
                    <div id="bj-player-cards" class="flex justify-center gap-2 h-28 mb-6"></div>
                    <p class="text-xs text-gray-500 uppercase mb-4 tracking-widest">Your Hand</p>

                    <div id="bj-controls-bet" class="w-full">
                        <div class="w-full max-w-xs mx-auto mb-4 bg-[#151517] p-3 rounded-lg border border-white/10">
                            <div class="relative mb-3"><input type="number" id="bj-bet-input" class="input-lux text-center text-2xl font-bold bg-transparent border-none p-0" value="500"></div>
                            <div class="grid grid-cols-5 gap-1">
                                <button onclick="app.setBet('bj', 100)" class="btn-preset">100</button>
                                <button onclick="app.setBet('bj', 500)" class="btn-preset">500</button>
                                <button onclick="app.setBet('bj', 1000)" class="btn-preset">1K</button>
                                <button onclick="app.setBet('bj', 5000)" class="btn-preset">5K</button>
                                <button onclick="app.setBet('bj', 'ALL')" class="btn-preset text-gold border-gold/30">ALL</button>
                            </div>
                        </div>
                        <button onclick="app.blackjack.deal()" class="btn-lux w-full border-gold text-gold font-bold">DEAL CARDS</button>
                    </div>
                    <div id="bj-controls-play" class="w-full flex gap-4 hidden">
                        <button onclick="app.blackjack.hit()" class="btn-lux flex-1 border-white/30 text-white hover:border-gold hover:bg-white/5 font-bold">HIT (+)</button>
                        <button onclick="app.blackjack.stand()" class="btn-lux flex-1 bg-gold/10 border-gold text-gold font-bold shadow-[0_0_15px_rgba(209,178,124,0.2)]">STAND (OK)</button>
                    </div>
                </div>
            </div>
        </section>

        <section id="view-slots" class="view-section z-20">
            <div class="absolute top-6 right-6 z-30 text-right">
                <p class="text-[10px] text-purple-200/50 uppercase tracking-widest">Balance</p>
                <p class="text-gold font-serif text-xl user-balance-display">$ 0</p>
            </div>
            <div class="absolute top-6 left-6 z-30 flex gap-3">
                <button onclick="app.switchView('view-hall')" class="text-gold font-serif italic hover:opacity-70 text-lg">← Quitter</button>
                <div class="sound-toggle-btn sound-icon-game" onclick="app.audio.toggle()">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"></polygon><path d="M19.07 4.93a10 10 0 0 1 0 14.14M15.54 8.46a5 5 0 0 1 0 7.07"></path></svg>
                </div>
            </div>

            <div class="w-full h-full flex flex-col items-center justify-center p-6 bg-[#1a1020]">
                <h2 class="font-serif text-3xl text-purple-300 italic mb-2">L'Amour Slots</h2>
                <p class="text-[10px] text-purple-200/50 uppercase tracking-widest mb-10">Machine à sous de luxe</p>

                <div class="slot-body relative mb-4 transform rotate-y-12">
                    <div class="reel-container">
                        <div class="win-line"></div>
                        <div class="reel-window"><div class="reel-strip" id="reel-1"><div class="reel-symbol symbol-7">7</div></div></div>
                        <div class="reel-window"><div class="reel-strip" id="reel-2"><div class="reel-symbol symbol-7">7</div></div></div>
                        <div class="reel-window"><div class="reel-strip" id="reel-3"><div class="reel-symbol symbol-7">7</div></div></div>
                    </div>
                    <div class="absolute -bottom-6 left-0 right-0 h-4 bg-black/40 blur-lg rounded-[50%]"></div>
                </div>

                <div id="slot-msg-area" class="h-16 text-center transition-opacity duration-300">
                    <p class="font-serif text-2xl text-purple-200 italic" id="slot-msg">Prêt?</p>
                    <p class="text-xs text-purple-400/60 font-sans mt-1 uppercase" id="slot-sub">Spin to Win</p>
                </div>

                <div class="w-full max-w-xs mt-4">
                    <div class="w-full max-w-xs mx-auto mb-4 bg-purple-900/20 p-3 rounded-lg border border-purple-500/20">
                        <div class="relative mb-3"><input type="number" id="slot-bet-input" class="input-lux text-center text-2xl font-bold bg-transparent border-none p-0 text-purple-200" value="100"></div>
                        <div class="grid grid-cols-5 gap-1">
                            <button onclick="app.setBet('slot', 50)" class="btn-preset text-purple-300 hover:text-white">50</button>
                            <button onclick="app.setBet('slot', 100)" class="btn-preset text-purple-300 hover:text-white">100</button>
                            <button onclick="app.setBet('slot', 500)" class="btn-preset text-purple-300 hover:text-white">500</button>
                            <button onclick="app.setBet('slot', 1000)" class="btn-preset text-purple-300 hover:text-white">1K</button>
                            <button onclick="app.setBet('slot', 'ALL')" class="btn-preset text-gold border-gold/30">MAX</button>
                        </div>
                    </div>
                    <button id="btn-spin" onclick="app.slots.spin()" class="btn-lux w-full border-purple-400 text-purple-300 hover:bg-purple-900/20 hover:shadow-[0_0_20px_rgba(157,78,221,0.3)]">TOURNER</button>
                </div>
            </div>
        </section>

        <section id="view-leaderboard" class="view-section z-30 bg-[#0A0A0C]">
             <div class="p-6 h-full flex flex-col">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="font-serif text-3xl text-gold italic">Classement</h2>
                    <button onclick="app.switchView('view-hall')" class="text-gray-500 hover:text-white text-2xl">&times;</button>
                </div>
                <div class="flex gap-2 mb-6">
                    <button onclick="app.leaderboard.switchTab('global')" id="tab-global" class="flex-1 py-2 text-xs uppercase tracking-wider border-b border-gold text-gold">Global</button>
                    <button onclick="app.leaderboard.switchTab('weekly')" id="tab-weekly" class="flex-1 py-2 text-xs uppercase tracking-wider border-b border-transparent text-gray-500">Weekly</button>
                    <button onclick="app.leaderboard.switchTab('streak')" id="tab-streak" class="flex-1 py-2 text-xs uppercase tracking-wider border-b border-transparent text-gray-500">Lịch sử</button>
                </div>
                <div id="lb-list" class="flex-1 overflow-y-auto deepglass rounded p-4 space-y-3"></div>
             </div>
        </section>

    </div>

    <script>
        const $ = (s) => document.querySelector(s);
        const $$ = (s) => document.querySelectorAll(s);
        const sleep = (ms) => new Promise(r => setTimeout(r, ms));

        function numberToEnglishText(n) {
            return n.toLocaleString() + " VND";
        }

        const app = {
            user: { name: "", id: "", score: 5000, history: [] },
            chartInstance: null,
            fxCanvas: null,
            fxCtx: null,
            particles: [],
            apiBase: "/api",
            sessionToken: null,
            
            checkBalance(amount) {
                if (this.user.score >= amount) return true;
                alert("Số dư không đủ!");
                return false;
            },

            setBet(game, val) {
                let inputId = '';
                if(game === 'tx') inputId = 'tx-bet-input';
                else if(game === 'bj') inputId = 'bj-bet-input';
                else if(game === 'slot') inputId = 'slot-bet-input';
                
                const input = $(`#${inputId}`);
                if(!input) return;

                if(val === 'ALL') {
                    input.value = this.user.score;
                } else {
                    input.value = parseInt(val);
                }
                this.audio.playClick();
            },
            
            audio: {
                ctx: null,
                muted: false,
                init() {
                    const AudioContext = window.AudioContext || window.webkitAudioContext;
                    if(AudioContext) this.ctx = new AudioContext();
                },
                toggle() {
                    this.muted = !this.muted;
                    $$('.sound-toggle-btn').forEach(btn => {
                        if(this.muted) {
                            btn.classList.add('muted');
                            btn.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"></polygon><line x1="23" y1="9" x2="17" y2="15"></line><line x1="17" y1="9" x2="23" y2="15"></line></svg>`;
                        } else {
                            btn.classList.remove('muted');
                            btn.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"></polygon><path d="M19.07 4.93a10 10 0 0 1 0 14.14M15.54 8.46a5 5 0 0 1 0 7.07"></path></svg>`;
                            if(this.ctx && this.ctx.state === 'suspended') this.ctx.resume();
                            this.playClick();
                        }
                    });
                },
                createOsc(freq, type, startTime, dur, vol = 0.1) {
                    if(!this.ctx) return;
                    const osc = this.ctx.createOscillator();
                    const gain = this.ctx.createGain();
                    osc.type = type;
                    osc.frequency.setValueAtTime(freq, startTime);
                    gain.gain.setValueAtTime(0, startTime);
                    gain.gain.linearRampToValueAtTime(vol, startTime + 0.01);
                    gain.gain.exponentialRampToValueAtTime(0.001, startTime + dur);
                    osc.connect(gain);
                    gain.connect(this.ctx.destination);
                    osc.start(startTime);
                    osc.stop(startTime + dur + 0.1);
                    return osc;
                },
                createNoise(type, dur, vol) {
                    if(!this.ctx) return;
                    const bufferSize = this.ctx.sampleRate * dur;
                    const buffer = this.ctx.createBuffer(1, bufferSize, this.ctx.sampleRate);
                    const data = buffer.getChannelData(0);
                    for (let i = 0; i < bufferSize; i++) data[i] = Math.random() * 2 - 1;

                    const noise = this.ctx.createBufferSource();
                    noise.buffer = buffer;
                    const gain = this.ctx.createGain();
                    const filter = this.ctx.createBiquadFilter();
                    
                    if(type === 'pink') {
                         filter.type = 'lowpass';
                         filter.frequency.value = 1000;
                    } else {
                         filter.type = 'highpass';
                         filter.frequency.value = 500;
                    }

                    gain.gain.setValueAtTime(vol, this.ctx.currentTime);
                    gain.gain.exponentialRampToValueAtTime(0.01, this.ctx.currentTime + dur);
                    
                    noise.connect(filter);
                    filter.connect(gain);
                    gain.connect(this.ctx.destination);
                    noise.start();
                },
                playWin() {
                    if(this.muted || !this.ctx) return;
                    const now = this.ctx.currentTime;
                    [523.25, 659.25, 783.99, 1046.50].forEach((f, i) => {
                        this.createOsc(f, 'sine', now + i*0.08, 1.2, 0.2); 
                        this.createOsc(f * 2, 'triangle', now + i*0.08, 0.6, 0.05);
                    });
                    for(let i=0; i<6; i++) {
                        setTimeout(() => this.createOsc(2000 + i*300, 'sine', this.ctx.currentTime, 0.1, 0.05), 400 + i*50);
                    }
                },
                playLose() {
                    if(this.muted || !this.ctx) return;
                    const now = this.ctx.currentTime;
                    this.createOsc(146.83, 'triangle', now, 0.6, 0.3);
                    this.createOsc(103.83, 'triangle', now + 0.4, 0.8, 0.3);
                },
                playClick() { 
                    if(this.muted || !this.ctx) return;
                    this.createOsc(2000, 'sine', this.ctx.currentTime, 0.05, 0.05);
                },
                playRoll() {
                    if(this.muted || !this.ctx) return;
                    for(let i=0; i<8; i++) {
                        setTimeout(() => {
                            this.createNoise('high', 0.05, 0.2);
                        }, i * 70 + Math.random()*20);
                    }
                },
                playCard() { 
                    if(this.muted || !this.ctx) return;
                    this.createNoise('pink', 0.1, 0.3);
                },
                playSlotSpin() {
                     if(this.muted || !this.ctx) return;
                     const osc = this.ctx.createOscillator();
                     const gain = this.ctx.createGain();
                     osc.type = 'sawtooth';
                     osc.frequency.setValueAtTime(100, this.ctx.currentTime);
                     osc.frequency.linearRampToValueAtTime(300, this.ctx.currentTime + 0.3);
                     
                     const filter = this.ctx.createBiquadFilter();
                     filter.type = 'lowpass';
                     filter.frequency.value = 400;

                     gain.gain.setValueAtTime(0.1, this.ctx.currentTime);
                     gain.gain.linearRampToValueAtTime(0, this.ctx.currentTime + 0.3);

                     osc.connect(filter);
                     filter.connect(gain);
                     gain.connect(this.ctx.destination);
                     osc.start();
                     osc.stop(this.ctx.currentTime + 0.3);
                },
                playSlotStop() {
                     if(this.muted || !this.ctx) return;
                     this.createOsc(150, 'square', this.ctx.currentTime, 0.1, 0.1);
                }
            },

            auth: {
                async register() {
                    app.audio.playClick();
                    const nameInput = $('#inp-name');
                    const passInput = $('#inp-pass');
                    const name = nameInput ? nameInput.value.trim() : "";
                    const pass = passInput ? passInput.value.trim() : "";
                    if(!name || !pass) { alert('Nhập tên và mật khẩu'); return; }
                    const res = await fetch(app.apiBase + '/register', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ name, password: pass })
                    });
                    const data = await res.json().catch(() => null);
                    if(!res.ok || !data || !data.ok) {
                        alert(data && data.error ? data.error : 'Không đăng ký được, thử tên khác.');
                        return;
                    }
                    app.setUserFromServer(data);
                    app.switchView('view-hall');
                },
                async login() {
                    app.audio.playClick();
                    const nameInput = $('#inp-name');
                    const passInput = $('#inp-pass');
                    const name = nameInput ? nameInput.value.trim() : "";
                    const pass = passInput ? passInput.value.trim() : "";
                    if(!name || !pass) { alert('Nhập tên và mật khẩu'); return; }
                    const res = await fetch(app.apiBase + '/login', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ name, password: pass })
                    });
                    const data = await res.json().catch(() => null);
                    if(!res.ok || !data || !data.ok) {
                        alert(data && data.error ? data.error : 'Sai tài khoản hoặc mật khẩu.');
                        return;
                    }
                    app.setUserFromServer(data);
                    app.switchView('view-hall');
                }
            },
            api: {
                async sendTx(amount, game) {
                    if(!app.sessionToken) return;
                    try {
                        const res = await fetch(app.apiBase + '/tx', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'Authorization': 'Bearer ' + app.sessionToken
                            },
                            body: JSON.stringify({ amount, game })
                        });
                        return await res.json();
                    } catch(e) { return null; }
                },
                async loadLeaderboard(tab) {
                    try {
                        const res = await fetch(app.apiBase + '/leaderboard?tab=' + encodeURIComponent(tab || 'global'));
                        const data = await res.json();
                        if(!res.ok || !data || !data.ok) return null;
                        return data;
                    } catch(e) { return null; }
                }
            },

            async syncData() {
                if(!app.sessionToken) return;
                const data = await app.api.sendTx(0, 'SYNC'); 
                if(data && data.ok) {
                    if(typeof data.score === 'number' && data.score !== app.user.score) {
                         app.animateBalance(data.score);
                         app.user.score = data.score;
                         if(app.profile.activeTab === 'bank' && $('#view-profile').classList.contains('active')) {
                             app.profile.loadBank(true);
                         }
                    }
                    if(typeof data.totalWins === 'number') app.user.totalWins = data.totalWins;
                    if(typeof data.maxWin === 'number') app.user.bestWin = data.maxWin;
                    app.pnl.renderStats();
                }
            },

            animateBalance(target) {
                const els = $$('.user-balance-display, #dash-score, #bank-balance');
                if(!els.length) return;
                
                const currentStr = $('#dash-score').innerText.replace('$ ','').replace(/,/g,'');
                const start = parseInt(currentStr) || 0;
                
                if(start === target) return;

                if (target < start) {
                    els.forEach(el => el.innerText = '$ ' + target.toLocaleString());
                    return;
                }

                const duration = 1500;
                const startTime = performance.now();

                function update(time) {
                    const elapsed = time - startTime;
                    const progress = Math.min(elapsed / duration, 1);
                    const ease = 1 - Math.pow(1 - progress, 3);
                    
                    const val = Math.floor(start + (target - start) * ease);
                    els.forEach(el => el.innerText = '$ ' + val.toLocaleString());

                    if(progress < 1) requestAnimationFrame(update);
                }
                requestAnimationFrame(update);
            },

            taixiu: {
                selection: null,
                isRolling: false,
                reset() {
                    this.selection = null;
                    this.isRolling = false;
                    $('#btn-tai').classList.remove('btn-selected');
                    $('#btn-xiu').classList.remove('btn-selected');
                    $('#btn-tx-roll').classList.remove('opacity-100', 'pointer-events-auto');
                    $('#btn-tx-roll').classList.add('opacity-30', 'pointer-events-none');
                    $('#tx-result').style.opacity = '0';
                },
                select(side) {
                    app.audio.playClick();
                    if(this.isRolling) return;
                    this.selection = side;
                    $('#btn-tai').classList.toggle('btn-selected', side === 'TAI');
                    $('#btn-xiu').classList.toggle('btn-selected', side === 'XIU');
                    $('#btn-tx-roll').classList.add('opacity-100', 'pointer-events-auto');
                    $('#btn-tx-roll').classList.remove('opacity-30', 'pointer-events-none');
                },
                async roll() {
                    const amount = parseInt($('#tx-bet-input').value);
                    if(!app.checkBalance(amount)) return;
                    
                    this.isRolling = true;
                    app.user.score -= amount;
                    app.animateBalance(app.user.score);
                    
                    app.audio.playRoll();
                    const dice = [$('#die-1'), $('#die-2'), $('#die-3')];
                    dice.forEach(d => d.classList.add('shaking'));
                    
                    await sleep(1500);
                    
                    const res = [1,2,3].map(() => Math.floor(Math.random()*6)+1);
                    dice.forEach((d, i) => {
                        d.classList.remove('shaking');
                        d.setAttribute('data-val', res[i]);
                    });

                    const total = res.reduce((a,b)=>a+b,0);
                    const isTai = total >= 11 && total <= 17;
                    const isXiu = total >= 4 && total <= 10;
                    const isTriple = res[0] === res[1] && res[1] === res[2]; 
                    
                    let won = false;
                    if(isTriple) won = false; 
                    else if(this.selection === 'TAI' && isTai) won = true;
                    else if(this.selection === 'XIU' && isXiu) won = true;
                    
                    const msgEl = $('#tx-msg');
                    const subEl = $('#tx-sub');
                    const resDiv = $('#tx-result');
                    
                    if(won) {
                        const profit = amount; 
                        app.recordTx(profit, 'Tai Xiu');
                        msgEl.innerText = "CHIẾN THẮNG!";
                        msgEl.className = "font-serif text-3xl italic text-green-400";
                    } else {
                        app.recordTx(-amount, 'Tai Xiu');
                        msgEl.innerText = "THẤT BẠI";
                        msgEl.className = "font-serif text-3xl italic text-red-500";
                    }
                    
                    subEl.innerText = `${total} ĐIỂM • ${isTai ? 'TÀI' : 'XỈU'} ${isTriple ? '• BÃO' : ''}`;
                    resDiv.style.opacity = '1';
                    this.isRolling = false;
                }
            },

            blackjack: {
                deck: [],
                playerHand: [],
                dealerHand: [],
                gameActive: false,
                betAmount: 0,
                
                reset() {
                    this.gameActive = false;
                    this.playerHand = [];
                    this.dealerHand = [];
                    $('#bj-player-cards').innerHTML = '';
                    $('#bj-dealer-cards').innerHTML = '';
                    $('#bj-player-score').innerText = '0';
                    $('#bj-dealer-score').innerText = '0';
                    $('#bj-dealer-score-box').classList.add('opacity-0');
                    $('#bj-controls-bet').classList.remove('hidden');
                    $('#bj-controls-play').classList.add('hidden');
                    $('#bj-msg').style.opacity = '0';
                },
                
                createDeck() {
                    const suits = ['h', 'd', 'c', 's'];
                    const ranks = ['2','3','4','5','6','7','8','9','10','J','Q','K','A'];
                    let deck = [];
                    for(let s of suits) {
                        for(let r of ranks) {
                            let val = parseInt(r);
                            if(r === 'J' || r === 'Q' || r === 'K') val = 10;
                            if(r === 'A') val = 11;
                            deck.push({ r, s, val });
                        }
                    }
                    return deck.sort(() => Math.random() - 0.5);
                },
                
                getCardHtml(card, hidden=false) {
                    if(hidden) return `<div class="card-bj card-back deal-anim"><div class="card-value-lg">?</div></div>`;
                    const color = (card.s === 'h' || card.s === 'd') ? 'red' : 'black';
                    const suitIcon = {'h':'♥','d':'♦','c':'♣','s':'♠'}[card.s];
                    return `<div class="card-bj ${color} deal-anim">
                        <div class="card-top-val">${card.r}<br>${suitIcon}</div>
                        <div class="card-value-lg">${suitIcon}</div>
                        <div class="card-top-val" style="transform: rotate(180deg)">${card.r}<br>${suitIcon}</div>
                    </div>`;
                },
                
                calcScore(hand) {
                    let score = 0;
                    let aces = 0;
                    hand.forEach(c => {
                        score += c.val;
                        if(c.r === 'A') aces++;
                    });
                    while(score > 21 && aces > 0) {
                        score -= 10;
                        aces--;
                    }
                    return score;
                },
                
                async deal() {
                    const amount = parseInt($('#bj-bet-input').value);
                    if(!app.checkBalance(amount)) return;
                    
                    app.audio.playClick();
                    this.betAmount = amount;
                    app.user.score -= amount;
                    app.animateBalance(app.user.score);
                    
                    this.deck = this.createDeck();
                    this.playerHand = [this.deck.pop(), this.deck.pop()];
                    this.dealerHand = [this.deck.pop(), this.deck.pop()];
                    this.gameActive = true;
                    
                    $('#bj-controls-bet').classList.add('hidden');
                    $('#bj-controls-play').classList.remove('hidden');
                    $('#bj-msg').style.opacity = '0';
                    $('#bj-dealer-score-box').classList.add('opacity-0');
                    
                    this.renderHands(true);
                    
                    const pScore = this.calcScore(this.playerHand);
                    if(pScore === 21) {
                         await sleep(500);
                         this.stand();
                    }
                },
                
                renderHands(hideDealer=true) {
                    const pContainer = $('#bj-player-cards');
                    const dContainer = $('#bj-dealer-cards');
                    
                    pContainer.innerHTML = this.playerHand.map(c => this.getCardHtml(c)).join('');
                    if(hideDealer) {
                        dContainer.innerHTML = this.getCardHtml(this.dealerHand[0]) + this.getCardHtml(null, true);
                    } else {
                        dContainer.innerHTML = this.dealerHand.map(c => this.getCardHtml(c)).join('');
                    }
                    
                    $('#bj-player-score').innerText = this.calcScore(this.playerHand);
                    if(!hideDealer) {
                        $('#bj-dealer-score').innerText = this.calcScore(this.dealerHand);
                        $('#bj-dealer-score-box').classList.remove('opacity-0');
                    }
                    app.audio.playCard();
                },
                
                hit() {
                    if(!this.gameActive) return;
                    app.audio.playClick();
                    this.playerHand.push(this.deck.pop());
                    this.renderHands(true);
                    
                    const score = this.calcScore(this.playerHand);
                    if(score > 21) this.endGame('BUST');
                    else if(score === 21) setTimeout(() => this.stand(), 500);
                },
                
                async stand() {
                    if(!this.gameActive) return;
                    app.audio.playClick();
                    this.gameActive = false;
                    this.renderHands(false);
                    
                    let dScore = this.calcScore(this.dealerHand);
                    while(dScore < 17) {
                        await sleep(800);
                        this.dealerHand.push(this.deck.pop());
                        this.renderHands(false);
                        dScore = this.calcScore(this.dealerHand);
                    }
                    
                    const pScore = this.calcScore(this.playerHand);
                    
                    if(dScore > 21) this.endGame('WIN');
                    else if(pScore > dScore) this.endGame('WIN');
                    else if(pScore < dScore) this.endGame('LOSE');
                    else this.endGame('PUSH');
                },
                
                endGame(res) {
                    this.gameActive = false;
                    $('#bj-controls-play').classList.add('hidden');
                    setTimeout(() => {
                         $('#bj-controls-bet').classList.remove('hidden');
                    }, 1500);
                    
                    const msgEl = $('#bj-msg');
                    
                    if(res === 'WIN') {
                        const winAmt = this.betAmount * 2;
                        app.recordTx(this.betAmount, 'Blackjack'); 
                        msgEl.innerText = "YOU WIN!";
                        msgEl.className = "font-serif text-3xl italic text-green-400 shadow-black drop-shadow-lg";
                    } else if (res === 'BUST') {
                        app.recordTx(-this.betAmount, 'Blackjack');
                        msgEl.innerText = "BUST!";
                        msgEl.className = "font-serif text-3xl italic text-red-500 shadow-black drop-shadow-lg";
                    } else if (res === 'LOSE') {
                        app.recordTx(-this.betAmount, 'Blackjack');
                        msgEl.innerText = "DEALER WINS";
                        msgEl.className = "font-serif text-3xl italic text-red-500 shadow-black drop-shadow-lg";
                    } else {
                        app.user.score += this.betAmount; 
                        app.animateBalance(app.user.score);
                        msgEl.innerText = "PUSH";
                        msgEl.className = "font-serif text-3xl italic text-gray-300 shadow-black drop-shadow-lg";
                    }
                    msgEl.style.opacity = '1';
                }
            },

            slots: {
                isSpinning: false,
                symbols: [
                    {id:'7', html:'<div class="reel-symbol symbol-7">7</div>', val: 5},
                    {id:'bell', html:'<div class="reel-symbol symbol-bell">🔔</div>', val: 3},
                    {id:'star', html:'<div class="reel-symbol symbol-star">⭐</div>', val: 4},
                    {id:'dia', html:'<div class="reel-symbol symbol-diamond">💎</div>', val: 2},
                    {id:'crown', html:'<div class="reel-symbol symbol-crown">👑</div>', val: 6}
                ],
                
                reset() {
                    this.isSpinning = false;
                    $('#slot-msg').innerText = "Prêt?";
                    $('#slot-sub').innerText = "Spin to Win";
                    $('#slot-msg-area').style.opacity = '1';
                    $('.win-line').style.display = 'none';
                    $('#btn-spin').disabled = false;
                    $('#btn-spin').style.opacity = '1';
                },
                
                async spin() {
                    const amount = parseInt($('#slot-bet-input').value);
                    if(!app.checkBalance(amount)) return;
                    
                    this.isSpinning = true;
                    app.user.score -= amount;
                    app.animateBalance(app.user.score);
                    $('#btn-spin').disabled = true;
                    $('#btn-spin').style.opacity = '0.5';
                    $('#slot-msg-area').style.opacity = '0';
                    $('.win-line').style.display = 'none';
                    
                    app.audio.playSlotSpin();
                    
                    const reels = [$('#reel-1'), $('#reel-2'), $('#reel-3')];
                    const result = [];
                    
                    // Start spin animation
                    reels.forEach(r => {
                        r.style.transition = 'none';
                        r.style.transform = 'translateY(0)';
                        // Fill reel with random symbols for blur effect
                        r.innerHTML = Array(20).fill(0).map(() => 
                            this.symbols[Math.floor(Math.random()*this.symbols.length)].html
                        ).join('');
                        
                        // Force reflow
                        void r.offsetWidth;
                        
                        r.style.transition = 'transform 2s cubic-bezier(0.2, 0.8, 0.2, 1)';
                        r.style.transform = 'translateY(-1500px)';
                    });
                    
                    // Determine result
                    for(let i=0; i<3; i++) {
                        await sleep(500 + i*300);
                        const sym = this.symbols[Math.floor(Math.random()*this.symbols.length)];
                        result.push(sym);
                        
                        const r = reels[i];
                        r.style.transition = 'none';
                        r.style.transform = 'translateY(-120px)'; 
                        r.innerHTML = 
                            this.symbols[Math.floor(Math.random()*this.symbols.length)].html + 
                            sym.html + 
                            this.symbols[Math.floor(Math.random()*this.symbols.length)].html;
                        
                        void r.offsetWidth;
                        r.style.transition = 'transform 0.3s ease-out';
                        r.style.transform = 'translateY(-120px)'; 
                        
                        app.audio.playSlotStop();
                    }
                    
                    // Check win
                    const allSame = result[0].id === result[1].id && result[1].id === result[2].id;
                    const msgEl = $('#slot-msg');
                    const subEl = $('#slot-sub');
                    const area = $('#slot-msg-area');
                    
                    if(allSame) {
                        const mult = result[0].val * 5; 
                        const win = amount * mult;
                        app.recordTx(win - amount, 'Slots'); 
                        msgEl.innerText = "JACKPOT!";
                        msgEl.className = "font-serif text-3xl italic text-gold";
                        subEl.innerText = `Win $ ${win.toLocaleString()}`;
                        $('.win-line').style.display = 'block';
                        app.triggerWinFx(win);
                    } else if (result[0].id === result[1].id || result[1].id === result[2].id || result[0].id === result[2].id) {
                         // Small win for pair
                         const win = Math.floor(amount * 1.5);
                         app.recordTx(win - amount, 'Slots');
                         msgEl.innerText = "NICE!";
                         msgEl.className = "font-serif text-3xl italic text-purple-300";
                         subEl.innerText = `Win $ ${win.toLocaleString()}`;
                    } else {
                        app.recordTx(-amount, 'Slots');
                        msgEl.innerText = "Try Again";
                        msgEl.className = "font-serif text-2xl italic text-gray-400";
                        subEl.innerText = "";
                    }
                    
                    area.style.opacity = '1';
                    this.isSpinning = false;
                    $('#btn-spin').disabled = false;
                    $('#btn-spin').style.opacity = '1';
                }
            },

            leaderboard: {
                activeTab: 'global',
                switchTab(tab) {
                    app.audio.playClick();
                    this.activeTab = tab;
                    $$('#view-leaderboard button[id^="tab-"]').forEach(b => {
                        b.className = 'flex-1 py-2 text-xs uppercase tracking-wider border-b border-transparent text-gray-500';
                    });
                    $(`#tab-${tab}`).className = 'flex-1 py-2 text-xs uppercase tracking-wider border-b border-gold text-gold';
                    this.render(tab);
                },
                async render(tab, silent=false) {
                    const list = $('#lb-list');
                    if(!silent) list.innerHTML = '<div class="text-center text-gray-500 text-xs py-4">Loading...</div>';
                    
                    const data = await app.api.loadLeaderboard(tab);
                    if(data && data.items) {
                        list.innerHTML = data.items.map((it, idx) => {
                            if (tab === 'streak') {
                                const win = it.amount >= 0;
                                return `
                                <div class="rank-row flex items-center justify-between py-2">
                                    <div class="flex items-center gap-3">
                                        <div class="text-xs font-mono text-gray-500 w-4">${idx+1}</div>
                                        <div>
                                            <div class="text-sm font-bold text-gray-200">${it.name}</div>
                                            <div class="text-[9px] text-gray-500 uppercase">${it.game}</div>
                                        </div>
                                    </div>
                                    <div class="text-right">
                                        <div class="font-mono text-xs font-bold ${win?'text-green-400':'text-red-400'}">${win?'+':''}$ ${Math.abs(it.amount).toLocaleString()}</div>
                                        <div class="text-[9px] text-gray-600">Now</div>
                                    </div>
                                </div>`;
                            } else {
                                const isTop = idx < 3;
                                const rankColor = idx === 0 ? 'text-yellow-400' : idx === 1 ? 'text-gray-300' : idx === 2 ? 'text-amber-600' : 'text-gray-600';
                                return `
                                <div class="rank-row flex items-center justify-between py-3">
                                    <div class="flex items-center gap-3">
                                        <div class="font-serif text-lg font-bold w-6 text-center ${rankColor}">${idx+1}</div>
                                        <div class="text-sm font-bold text-gray-200">${it.name}</div>
                                    </div>
                                    <div class="font-mono text-gold text-sm">$ ${it.score.toLocaleString()}</div>
                                </div>`;
                            }
                        }).join('');
                    } else {
                        list.innerHTML = '<div class="text-center text-gray-500 text-xs py-4">No data</div>';
                    }
                }
            },

            feed: {
                async init() {
                    this.update();
                    setInterval(() => this.update(), 8000); 
                },

                async update() {
                    const data = await app.api.loadLeaderboard('streak');
                    if(data && data.items && data.items.length > 0) {
                        const realPlayers = data.items.slice(0, 3); 
                        this.render(realPlayers);
                    }
                },

                render(items) {
                    const container = $('#live-feed-list');
                    if(!container) return;
                    
                    container.innerHTML = items.map(i => {
                        const win = i.amount >= 0;
                        const amountClass = win ? "text-green-400" : "text-red-400";
                        const sign = win ? "+" : "";
                        const icon = win ? "↗" : "↘";
                        const time = "Mới đây"; 
                        
                        return `
                        <div class="feed-item p-3 flex justify-between items-center hover:bg-white/5 transition-colors">
                            <div class="flex items-center gap-3">
                                <div class="w-8 h-8 rounded-full bg-white/5 border border-white/10 flex items-center justify-center text-[10px] text-gray-400 font-serif">
                                    ${i.name.charAt(0)}
                                </div>
                                <div>
                                    <p class="text-xs font-bold text-gray-200">${i.name}</p>
                                    <p class="text-[9px] text-gray-500 uppercase tracking-wide">${i.game} • ${time}</p>
                                </div>
                            </div>
                            <div class="text-right">
                                <p class="text-xs font-mono font-bold ${amountClass}">${sign}$ ${Math.abs(i.amount).toLocaleString()}</p>
                                <p class="text-[9px] text-gray-600">${win ? 'WIN' : 'LOST'} ${icon}</p>
                            </div>
                        </div>
                        `;
                    }).join('');
                }
            },

            profile: {
                activeTab: 'bank',
                historyInterval: null,
                switchTab(tab) {
                    app.audio.playClick();
                    this.activeTab = tab;
                    $$('[id^="pf-content-"]').forEach(el => el.classList.add('hidden'));
                    $$('[id^="pf-tab-"]').forEach(el => {
                        el.className = 'flex-1 py-2 text-xs uppercase tracking-wider text-gray-500';
                    });
                    
                    $(`#pf-content-${tab}`).classList.remove('hidden');
                    $(`#pf-tab-${tab}`).className = 'flex-1 py-2 text-xs uppercase tracking-wider text-gold font-bold border-b-2 border-gold';
                    
                    if(this.historyInterval) clearInterval(this.historyInterval);

                    if (tab === 'bank') {
                        this.loadBank();
                        this.historyInterval = setInterval(() => this.loadBank(true), 3000);
                    }
                    if (tab === 'perf') app.pnl.render();
                },
                async loadBank(silent = false) {
                    const res = await fetch(app.apiBase + '/transfer?type=history', {
                         headers: { 'Authorization': 'Bearer ' + app.sessionToken }
                    });
                    const data = await res.json();
                    const list = $('#tx-history-list');
                    if (!silent) list.innerHTML = '<div class="p-4 text-center text-xs text-gray-600 italic">Đang tải...</div>';
                    
                    if(data.ok && data.items && data.items.length > 0) {
                        const html = data.items.map(t => {
                            const isSend = String(t.sender_id) === String(app.user.id.replace('U',''));
                            const isReceive = !isSend;
                            
                            const amountCls = isReceive ? "text-green-400" : "text-red-400";
                            const iconCls = isReceive ? "bg-green-500/10 text-green-500" : "bg-red-500/10 text-red-500";
                            const arrow = isReceive ? "↓" : "↑";
                            const sign = isReceive ? "+" : "-";
                            
                            const label = isReceive ? `Nhận từ: ${t.sender_name}` : `Gửi đến: ${t.receiver_name}`;
                            const date = new Date(t.created_at * 1000).toLocaleString('vi-VN');

                            return `
                            <div class="flex items-center justify-between p-3 border-b border-white/5 bg-white/5 rounded-lg mb-2 hover:bg-white/10 transition-colors">
                                <div class="flex items-center gap-3">
                                     <div class="w-8 h-8 rounded-full ${iconCls} flex items-center justify-center font-bold text-sm">
                                         ${arrow}
                                     </div>
                                     <div>
                                         <p class="text-xs font-bold text-gray-200 font-serif">${label}</p>
                                         <p class="text-[9px] text-gray-500 font-mono mt-0.5">TX: ${t.tx_code}</p>
                                     </div>
                                </div>
                                <div class="text-right">
                                     <p class="font-mono font-bold text-sm ${amountCls}">
                                         ${sign}$ ${t.amount.toLocaleString()}
                                     </p>
                                     <p class="text-[9px] text-gray-500">${date}</p>
                                </div>
                            </div>`;
                        }).join('');
                        
                        if (list.innerHTML !== html) list.innerHTML = html;
                    } else {
                        if (!silent) list.innerHTML = `<div class="p-4 text-center text-xs text-gray-600 italic">Chưa có giao dịch nào</div>`;
                    }
                },
                async checkUser() {
                    const val = $('#tx-receiver').value.trim();
                    const preview = $('#rx-preview');
                    const loader = $('#rx-check-loading');
                    
                    if(!val) { preview.innerText = ''; return; }
                    
                    loader.classList.remove('hidden');
                    try {
                        const res = await fetch(app.apiBase + '/transfer?type=check&q=' + encodeURIComponent(val), {
                             headers: { 'Authorization': 'Bearer ' + app.sessionToken }
                        });
                        const data = await res.json();
                        loader.classList.add('hidden');
                        
                        if(data.ok) {
                            preview.innerHTML = `<span class="text-green-500">✓ Tìm thấy:</span> <span class="text-gold font-bold">${data.name}</span> (ID: ${data.id})`;
                        } else {
                             preview.innerHTML = `<span class="text-red-500">✗ Không tìm thấy người dùng này</span>`;
                        }
                    } catch(e) {
                        loader.classList.add('hidden');
                    }
                },
                async sendMoney() {
                    app.audio.playClick();
                    const receiver = $('#tx-receiver').value.trim();
                    const amount = parseInt($('#tx-amount').value);
                    if(!receiver || !amount) return alert("Vui lòng nhập đủ thông tin");
                    
                    const btn = event.target; btn.disabled = true; btn.innerText = "ĐANG XỬ LÝ...";
                    
                    try {
                        const res = await fetch(app.apiBase + '/transfer', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json', 'Authorization': 'Bearer ' + app.sessionToken },
                            body: JSON.stringify({ receiver, amount })
                        });
                        const data = await res.json();
                        
                        if(data.ok) {
                            app.animateBalance(data.newBalance);
                            app.user.score = data.newBalance;
                            this.showBill(data);
                            setTimeout(() => this.loadBank(), 500); 
                            $('#tx-receiver').value = ''; $('#tx-amount').value = ''; $('#rx-preview').innerText = '';
                        } else {
                            alert(data.error || "Lỗi giao dịch");
                        }
                    } catch(e) { alert("Lỗi kết nối"); }
                    btn.disabled = false; btn.innerText = "XÁC NHẬN CHUYỂN";
                },
                showBill(data) {
                    $('#bill-id').innerText = '#' + (data.txCode || data.txId || '0000');
                    $('#bill-date').innerText = new Date(data.date).toLocaleString('vi-VN');
                    $('#bill-sender').innerText = data.sender;
                    $('#bill-receiver').innerText = data.receiver;
                    $('#bill-amount').innerText = '$ ' + data.amount.toLocaleString();
                    
                    app.audio.playWin();
                    $('#bill-modal').classList.add('active');
                }
            },

            trading: {
                chartCtx: null,
                isTrading: false,
                currentPrice: 54000,
                candles: [], 
                currentCandle: null,
                betTime: 30, 
                leverage: 10,
                activeOrder: null, 
                interval: null,
                
                volatility: 0.8,
                momentum: 0,
                jumpProb: 0.02,
                panicCounter: 0,
                
                scaleX: 1.0,
                offsetX: 0,
                isDragging: false,
                lastX: 0,
                
                initialPinchDist: null,
                initialScaleX: null,
                
                init() {
                    const cvs = document.getElementById('tradeChart');
                    if (cvs) {
                        const dpr = window.devicePixelRatio || 1;
                        const rect = cvs.getBoundingClientRect();
                        cvs.width = rect.width * dpr;
                        cvs.height = rect.height * dpr;
                        this.chartCtx = cvs.getContext('2d');
                        this.chartCtx.scale(dpr, dpr);
                        
                        this.candles = [];
                        let p = 54000;
                        const now = Math.floor(Date.now() / 1000);
                        
                        for(let i=0; i<100; i++) {
                            p += (Math.random() - 0.5) * 10;
                            const o = p;
                            const c = p + (Math.random() - 0.5) * 8;
                            const h = Math.max(o, c) + Math.random() * 3;
                            const l = Math.min(o, c) - Math.random() * 3;
                            const v = Math.random() * 100 + 50; 
                            this.candles.push({ o, h, l, c, v, t: now - (100-i) });
                            p = c;
                        }
                        this.currentPrice = p;
                        this.currentCandle = { o: p, h: p, l: p, c: p, v: 0, t: now };
                        
                        cvs.addEventListener('mousedown', e => this.startDrag(e));
                        window.addEventListener('mousemove', e => this.drag(e));
                        window.addEventListener('mouseup', () => this.endDrag());
                        
                        cvs.addEventListener('touchstart', e => this.handleTouchStart(e), {passive: false});
                        window.addEventListener('touchmove', e => this.handleTouchMove(e), {passive: false});
                        window.addEventListener('touchend', e => this.handleTouchEnd(e));
                        
                        cvs.addEventListener('wheel', e => this.zoom(e), {passive: false});

                        this.startLoop();
                    }
                },
                
                startDrag(e) {
                    this.isDragging = true;
                    this.lastX = e.touches ? e.touches[0].clientX : e.clientX;
                },
                
                drag(e) {
                    if(!this.isDragging) return;
                    e.preventDefault(); 
                    const x = e.touches ? e.touches[0].clientX : e.clientX;
                    const dx = x - this.lastX;
                    this.offsetX += dx;
                    this.lastX = x;
                },
                
                endDrag() {
                    this.isDragging = false;
                },
                
                zoom(e) {
                    e.preventDefault();
                    const delta = e.deltaY > 0 ? 0.9 : 1.1;
                    this.scaleX = Math.max(0.5, Math.min(this.scaleX * delta, 5.0));
                },
                
                handleTouchStart(e) {
                    if (e.touches.length === 2) {
                        this.isDragging = false;
                        const dist = Math.hypot(
                            e.touches[0].clientX - e.touches[1].clientX,
                            e.touches[0].clientY - e.touches[1].clientY
                        );
                        this.initialPinchDist = dist;
                        this.initialScaleX = this.scaleX;
                    } else if (e.touches.length === 1) {
                        this.startDrag(e);
                    }
                },

                handleTouchMove(e) {
                    e.preventDefault();
                    if (e.touches.length === 2 && this.initialPinchDist) {
                        const dist = Math.hypot(
                            e.touches[0].clientX - e.touches[1].clientX,
                            e.touches[0].clientY - e.touches[1].clientY
                        );
                        const scale = dist / this.initialPinchDist;
                        this.scaleX = Math.max(0.5, Math.min(this.initialScaleX * scale, 5.0));
                    } else if (e.touches.length === 1) {
                        this.drag(e);
                    }
                },

                handleTouchEnd(e) {
                    if (e.touches.length < 2) {
                        this.initialPinchDist = null;
                    }
                    if (e.touches.length === 0) {
                        this.endDrag();
                    }
                },
                
                setTime(t) {
                    app.audio.playClick();
                    if(this.isTrading) return;
                    this.betTime = t;
                    $$('.btn-time').forEach(b => {
                        b.classList.remove('active', 'bg-white/10', 'text-white');
                        b.classList.add('text-gray-400');
                    });
                    const btn = document.getElementById(`btn-time-${t}`);
                    if(btn) {
                        btn.classList.add('active', 'bg-white/10', 'text-white');
                        btn.classList.remove('text-gray-400');
                    }
                },

                setLeverage(l) {
                    app.audio.playClick();
                    if(this.isTrading) return;
                    let val = parseInt(l);
                    if (isNaN(val) || val < 1) val = 1;
                    if (val > 100) val = 100;
                    this.leverage = val;
                    const el = document.getElementById('leverage-input');
                    if(el) el.value = val;
                },
                
                placeOrder(dir) {
                    app.audio.playClick();
                    if(this.isTrading) return;
                    
                    const bet = parseInt(document.getElementById('trade-amount').value);
                    if(!app.checkBalance(bet)) return;
                    
                    this.isTrading = true;
                    this.activeOrder = {
                        dir: dir,
                        entry: this.currentPrice,
                        bet: bet,
                        lev: this.leverage,
                        startTime: Date.now(),
                        endTime: Date.now() + (this.betTime * 1000)
                    };
                    
                    const btnId = dir === 'up' ? 'btn-long' : 'btn-short';
                    const btn = document.getElementById(btnId);
                    btn.classList.add('ring-2', 'ring-white', 'ring-opacity-50');
                    
                    document.getElementById('trade-amount').disabled = true;
                    document.getElementById('leverage-input').disabled = true;
                    $$('.trade-btn-sm').forEach(b => b.disabled = true);
                    $$('.btn-time, #btn-long, #btn-short').forEach(b => b.disabled = true);
                    $$('#btn-long, #btn-short').forEach(b => {
                        if(b.id !== btnId) b.classList.add('opacity-30');
                    });
                    
                    document.getElementById('trade-timer-overlay').classList.remove('hidden');
                    document.getElementById('trade-pnl-live').classList.remove('hidden');
                    
                    app.user.score -= bet;
                    this.updateStaticBalance();
                },
                
                closeOrder(pnl) {
                    this.isTrading = false;
                    let payout = 0;
                    if (pnl + this.activeOrder.bet <= 0) {
                        payout = 0;
                    } else {
                        payout = this.activeOrder.bet + pnl;
                    }
                    
                    const profit = payout - this.activeOrder.bet;
                    app.recordTx(Math.round(profit), 'Trading 30s');
                    
                    const box = document.getElementById('trade-result-overlay');
                    const title = document.getElementById('trade-res-title');
                    const amt = document.getElementById('trade-res-amt');
                    
                    box.classList.remove('pointer-events-none', 'opacity-0');
                    document.getElementById('trade-result-box').classList.remove('scale-90');
                    document.getElementById('trade-result-box').classList.add('scale-100');
                    
                    if (profit > 0) {
                        app.audio.playWin();
                        title.innerText = "PROFIT";
                        title.className = "text-4xl font-serif italic mb-1 text-green-400";
                        amt.innerText = "+$ " + Math.round(profit).toLocaleString();
                        amt.className = "font-mono text-lg text-green-400 font-bold";
                    } else if (profit < 0) {
                        app.audio.playLose();
                        title.innerText = "LOSS";
                        title.className = "text-4xl font-serif italic mb-1 text-red-500";
                        amt.innerText = "-$ " + Math.abs(Math.round(profit)).toLocaleString();
                        amt.className = "font-mono text-lg text-red-500 font-bold";
                    } else {
                        title.innerText = "BREAK EVEN";
                        title.className = "text-4xl font-serif italic mb-1 text-white";
                        amt.innerText = "$ 0";
                        amt.className = "font-mono text-lg text-white font-bold";
                    }
                    
                    setTimeout(() => {
                         box.classList.add('pointer-events-none', 'opacity-0');
                         document.getElementById('trade-result-box').classList.add('scale-90');
                         document.getElementById('trade-result-box').classList.remove('scale-100');
                         
                        document.getElementById('trade-amount').disabled = false;
                        document.getElementById('leverage-input').disabled = false;
                        $$('.trade-btn-sm').forEach(b => b.disabled = false);
                        $$('.btn-time, #btn-long, #btn-short').forEach(b => {
                            b.disabled = false;
                            b.classList.remove('opacity-30', 'ring-2', 'ring-white', 'ring-opacity-50');
                        });
                        
                        document.getElementById('trade-timer-overlay').classList.add('hidden');
                        document.getElementById('trade-pnl-live').classList.add('hidden');
                        
                        this.activeOrder = null;
                        this.updateStaticBalance(); 
                    }, 2500);
                },
                
                updateStaticBalance() {
                    $$('.user-balance-display').forEach(el => el.textContent = '$ ' + app.user.score.toLocaleString());
                },
                
                startLoop() {
                    if (this.interval) return;
                    const loop = () => {
                        this.updatePrice();
                        this.drawChart();
                        requestAnimationFrame(loop);
                    };
                    requestAnimationFrame(loop);
                },
                
                updatePrice() {
                    
                    if(this.panicCounter > 0) {
                        this.volatility = 3.0 + Math.random() * 5.0;
                        this.panicCounter--;
                    } else {
                        if(Math.random() < 0.005) {
                            this.panicCounter = 30 + Math.floor(Math.random() * 30);
                            this.momentum = (Math.random() - 0.5) * 8.0;
                        } else {
                            this.volatility = 0.5 + Math.random() * 0.5;
                        }
                    }
                    
                    this.momentum = this.momentum * 0.92 + (Math.random() - 0.5) * 0.2;
                    
                    let jump = 0;
                    if(Math.random() < 0.01) {
                        jump = (Math.random() - 0.5) * 40 * this.volatility;
                    }
                    
                    let dramaMult = 1;
                    if(this.isTrading && this.activeOrder) {
                        const nowMs = Date.now();
                        const timeLeft = (this.activeOrder.endTime - nowMs) / 1000;
                        if(timeLeft < 5 && timeLeft > 0) {
                            dramaMult = 3.0;
                            if(Math.random() < 0.1) jump += (Math.random() - 0.5) * 50;
                        }
                    }
                    
                    const noise = (Math.random() - 0.5) * this.volatility * dramaMult;
                    const step = this.momentum + noise + jump;
                    this.currentPrice += step;
                    
                    this.currentCandle.c = this.currentPrice;
                    this.currentCandle.h = Math.max(this.currentCandle.h, this.currentPrice);
                    this.currentCandle.l = Math.min(this.currentCandle.l, this.currentPrice);
                    this.currentCandle.v += Math.abs(step) * 10; 
                    
                    const now = Math.floor(Date.now() / 1000);
                    if (now > this.currentCandle.t) {
                         this.candles.push({ ...this.currentCandle });
                         this.currentCandle = { o: this.currentPrice, h: this.currentPrice, l: this.currentPrice, c: this.currentPrice, v: 0, t: now };
                         if(this.candles.length > 500) this.candles.shift();
                    }
                    
                    const elPrice = document.getElementById('trade-price');
                    const elChange = document.getElementById('trade-change');
                    if(elPrice) {
                        elPrice.innerText = this.currentPrice.toFixed(2);
                        const startPrice = this.candles[0] ? this.candles[0].o : this.currentPrice;
                        const diff = this.currentPrice - startPrice;
                        const pct = (diff / startPrice) * 100;
                        elChange.innerText = (diff>=0?'+':'') + pct.toFixed(2) + '%';
                        elChange.className = `text-xs ${diff >= 0 ? 'text-green-500' : 'text-red-500'}`;
                        elPrice.className = `font-mono text-xl font-bold ${diff >= 0 ? 'text-green-400' : 'text-red-400'}`;
                    }
                    
                    if(this.isTrading && this.activeOrder) {
                        const nowMs = Date.now();
                        const timeLeft = Math.max(0, this.activeOrder.endTime - nowMs);
                        
                        document.getElementById('trade-countdown').innerText = (timeLeft/1000).toFixed(1) + 's';
                        
                        const priceDiff = this.currentPrice - this.activeOrder.entry;
                        const directionMult = this.activeOrder.dir === 'up' ? 1 : -1;
                        let pnlPercent = (priceDiff / this.activeOrder.entry) * this.activeOrder.lev * directionMult;
                        let currentPnL = this.activeOrder.bet * pnlPercent;
                        
                        const pnlEl = document.getElementById('pnl-live-val');
                        pnlEl.innerText = (currentPnL>=0?'+':'') + '$ ' + Math.round(currentPnL).toLocaleString();
                        pnlEl.className = `font-mono text-xl font-bold ${currentPnL >= 0 ? 'text-green-400' : 'text-red-500'}`;

                        if(timeLeft <= 0) this.closeOrder(currentPnL);
                    }
                },
                
                drawChart() {
                    const ctx = this.chartCtx;
                    if (!ctx) return;
                    
                    const cvs = ctx.canvas;
                    const parent = cvs.parentElement;
                    const dpr = window.devicePixelRatio || 1;
                    if (cvs.width !== parent.clientWidth * dpr || cvs.height !== parent.clientHeight * dpr) {
                         cvs.width = parent.clientWidth * dpr;
                         cvs.height = parent.clientHeight * dpr;
                         ctx.scale(dpr, dpr);
                    }
                    
                    const w = parent.clientWidth;
                    const h = parent.clientHeight;
                    
                    const rightMargin = 0; 
                    const chartW = w; 
                    
                    ctx.clearRect(0, 0, w, h);
                    
                    ctx.fillStyle = '#151518';
                    ctx.fillRect(0, 0, w, h);
                    
                    const candleBaseWidth = 10;
                    const candleWidth = candleBaseWidth * this.scaleX;
                    const spacing = 2 * this.scaleX;
                    const totalUnit = candleWidth + spacing;
                    
                    const maxVisible = Math.ceil(chartW / totalUnit);
                    const allCandles = [...this.candles, this.currentCandle];
                    const totalCandles = allCandles.length;
                    
                    const rightPaddingUnits = 12; 
                    
                    let viewEndIndex = totalCandles + rightPaddingUnits + (this.offsetX / totalUnit);
                    let viewStartIndex = viewEndIndex - maxVisible;
                    
                    if(viewEndIndex > totalCandles + 20) { 
                        this.offsetX = (totalCandles + 20 - rightPaddingUnits - totalCandles) * totalUnit; 
                        viewEndIndex = totalCandles + 20; 
                    }
                    
                    let minP = Infinity, maxP = -Infinity;
                    let maxV = 0;
                    
                    const visibleCandles = [];
                    for(let i = Math.floor(viewStartIndex); i <= Math.ceil(viewEndIndex); i++) {
                        if(i >= 0 && i < totalCandles) {
                            const c = allCandles[i];
                            visibleCandles.push({ ...c, i }); 
                            minP = Math.min(minP, c.l);
                            maxP = Math.max(maxP, c.h);
                            maxV = Math.max(maxV, c.v);
                        }
                    }
                    
                    if(minP === Infinity) { minP = this.currentPrice - 10; maxP = this.currentPrice + 10; }
                    
                    const padding = (maxP - minP) * 0.15;
                    const range = (maxP - minP) + (padding*2) || 1;
                    const getY = (price) => h - ((price - (minP - padding)) / range) * h;
                    
                    ctx.strokeStyle = 'rgba(255,255,255,0.03)';
                    ctx.lineWidth = 1;
                    ctx.beginPath();
                    
                    const gridSteps = 6;
                    for(let i=0; i<=gridSteps; i++) {
                        const y = h * (i/gridSteps);
                        ctx.moveTo(0, y); ctx.lineTo(chartW, y);
                    }
                    for(let i=0; i<chartW; i+=100) {
                        ctx.moveTo(i,0); ctx.lineTo(i,h);
                    }
                    ctx.stroke();
                    
                    const volHeight = h * 0.15;
                    visibleCandles.forEach(c => {
                        const x = (c.i - viewStartIndex) * totalUnit;
                        if(x + candleWidth < 0 || x > chartW) return;
                        
                        const vH = (c.v / maxV) * volHeight;
                        const isGreen = c.c >= c.o;
                        ctx.fillStyle = isGreen ? 'rgba(34, 197, 94, 0.1)' : 'rgba(239, 68, 68, 0.1)';
                        ctx.fillRect(x, h - vH, candleWidth, vH);
                    });

                    visibleCandles.forEach(c => {
                        const x = (c.i - viewStartIndex) * totalUnit;
                        if(x + candleWidth < 0 || x > chartW) return;
                        
                        const yO = getY(c.o);
                        const yC = getY(c.c);
                        const yH = getY(c.h);
                        const yL = getY(c.l);
                        
                        const isGreen = c.c >= c.o;
                        ctx.fillStyle = isGreen ? '#22c55e' : '#ef4444';
                        ctx.strokeStyle = isGreen ? '#22c55e' : '#ef4444';
                        ctx.lineWidth = 1;
                        
                        ctx.beginPath();
                        ctx.moveTo(x + candleWidth/2, yH);
                        ctx.lineTo(x + candleWidth/2, yL);
                        ctx.stroke();
                        
                        let bodyH = Math.abs(yC - yO);
                        if(bodyH < 1) bodyH = 1;
                        ctx.fillRect(x, Math.min(yO, yC), candleWidth, bodyH);
                    });
                    
                    if(this.isTrading && this.activeOrder) {
                        const yEntry = getY(this.activeOrder.entry);
                        ctx.beginPath();
                        ctx.moveTo(0, yEntry);
                        ctx.lineTo(chartW, yEntry);
                        ctx.strokeStyle = '#ffffff';
                        ctx.setLineDash([5, 5]);
                        ctx.stroke();
                        ctx.setLineDash([]);
                        ctx.fillStyle = '#fff';
                        ctx.fillText('ENTRY', 5, yEntry - 5);
                    }
                    
                    const yCurr = getY(this.currentPrice);
                    ctx.beginPath();
                    ctx.moveTo(0, yCurr);
                    ctx.lineTo(chartW, yCurr);
                    ctx.strokeStyle = 'rgba(209, 178, 124, 0.4)';
                    ctx.setLineDash([2, 2]);
                    ctx.stroke();
                    ctx.setLineDash([]);
                    
                    const axisW = 60;
                    const grad = ctx.createLinearGradient(w - axisW, 0, w, 0);
                    grad.addColorStop(0, 'rgba(21, 21, 24, 0)');
                    grad.addColorStop(0.3, 'rgba(21, 21, 24, 0.8)');
                    grad.addColorStop(1, 'rgba(21, 21, 24, 0.95)');
                    ctx.fillStyle = grad;
                    ctx.fillRect(w - axisW, 0, axisW, h);
                    
                    ctx.fillStyle = 'rgba(255,255,255,0.5)';
                    ctx.font = '10px monospace';
                    ctx.textAlign = 'right';
                    
                    for(let i=0; i<=gridSteps; i++) {
                        const price = (minP - padding) + (range * (1 - i/gridSteps));
                        const y = h * (i/gridSteps);
                        if (Math.abs(y - yCurr) > 15) { 
                            ctx.fillText(price.toFixed(2), w - 8, y + 3);
                        }
                    }
                    
                    const isUp = this.currentPrice >= (this.candles[0]?.o || 0);
                    ctx.fillStyle = isUp ? '#22c55e' : '#ef4444';
                    const badgeW = 55;
                    const badgeH = 18;
                    const badgeX = w - badgeW - 2;
                    const badgeY = yCurr - badgeH/2;
                    
                    ctx.fillRect(badgeX, badgeY, badgeW, badgeH);
                    
                    ctx.beginPath();
                    ctx.moveTo(badgeX, badgeY + badgeH/2);
                    ctx.lineTo(badgeX - 5, badgeY + badgeH/2);
                    ctx.strokeStyle = isUp ? '#22c55e' : '#ef4444';
                    ctx.lineWidth = 2;
                    ctx.stroke();

                    ctx.fillStyle = '#000';
                    ctx.font = 'bold 10px monospace';
                    ctx.textAlign = 'center';
                    ctx.fillText(this.currentPrice.toFixed(2), badgeX + badgeW/2, badgeY + 12);
                }
            },

            init() {
                this.loadUser();
                this.createParticles();
                this.initFxCanvas();
                this.audio.init();
                this.feed.init(); 
                if(this.user.name) {
                    $('#inp-name').value = this.user.name;
                    this.switchView('view-hall');
                    this.updateDash();
                }
                
                this.trading.init();
                
                this.animLoop();
                setInterval(() => this.syncData(), 2000);
                setInterval(() => this.leaderboard.render(this.leaderboard.activeTab, true), 10000);
                
                const rxInput = $('#tx-receiver');
                if(rxInput) {
                    let timeout = null;
                    rxInput.addEventListener('keyup', () => {
                        clearTimeout(timeout);
                        timeout = setTimeout(() => this.profile.checkUser(), 500);
                    });
                }
            },

            initFxCanvas() {
                this.fxCanvas = $('#fx-canvas');
                this.fxCanvas.width = window.innerWidth;
                this.fxCanvas.height = window.innerHeight;
                this.fxCtx = this.fxCanvas.getContext('2d');
                window.addEventListener('resize', () => {
                    this.fxCanvas.width = window.innerWidth;
                    this.fxCanvas.height = window.innerHeight;
                });
            },

            setUserFromServer(data) {
                if(!data || !data.user || !data.token) return;
                const u = data.user;
                this.user.name = u.name;
                this.user.id = 'U' + u.id;
                this.user.score = u.score;
                this.user.history = Array.isArray(u.history) ? u.history : [];
                this.user.totalWins = typeof u.totalWins === 'number' ? u.totalWins : 0;
                this.user.bestWin = typeof u.bestWin === 'number' ? u.bestWin : 0;
                this.sessionToken = data.token;
                this.saveUser();
            },

            switchView(id) {
                app.audio.playClick();
                
                if(app.profile.historyInterval) {
                    clearInterval(app.profile.historyInterval);
                    app.profile.historyInterval = null;
                }

                $$('.view-section').forEach(el => {
                    el.classList.remove('active');
                    el.style.pointerEvents = 'none';
                });
                
                const mainApp = document.getElementById('app');
                if(id === 'view-trading') {
                     mainApp.classList.remove('max-w-md');
                     mainApp.classList.add('full-screen-mode'); 
                } else {
                     mainApp.classList.add('max-w-md');
                     mainApp.classList.remove('full-screen-mode');
                }
                
                setTimeout(() => {
                    $(`#${id}`).classList.add('active');
                    $(`#${id}`).style.pointerEvents = 'auto';
                    
                    if(id === 'view-trading' && app.trading.chartCtx) {
                         const cvs = document.getElementById('tradeChart');
                         const rect = cvs.parentElement.getBoundingClientRect();
                         setTimeout(() => {
                             const dpr = window.devicePixelRatio || 1;
                             cvs.width = rect.width * dpr;
                             cvs.height = rect.height * dpr;
                             app.trading.chartCtx.scale(dpr, dpr);
                         }, 50);
                    }
                }, 100); 
            },

            logout() {
                app.audio.playClick();
                if(confirm("Exit Salon?")) {
                    localStorage.removeItem('salon_user');
                    location.reload();
                }
            },

            updateDash() {
                $('#dash-name').textContent = this.user.name;
                $('#dash-id').textContent = this.user.id;
                const scoreStr = '$ ' + this.user.score.toLocaleString();
                $('#dash-score').textContent = scoreStr;
                $('#bank-balance').textContent = scoreStr; 
                $$('.user-balance-display').forEach(el => el.textContent = scoreStr);
            },

            saveUser() {
                const payload = { user: this.user, token: this.sessionToken };
                localStorage.setItem('salon_user', JSON.stringify(payload));
                this.updateDash();
            },

            loadUser() {
                const data = localStorage.getItem('salon_user');
                if(data) {
                    try {
                        const obj = JSON.parse(data);
                        if(obj && obj.user) {
                            this.user = obj.user;
                            this.sessionToken = obj.token || null;
                        } else {
                            this.user = obj;
                        }
                    } catch(e) {}
                    if(!this.user.history) this.user.history = [];
                }
            },

            recordTx(amount, game) {
                this.user.score += amount;
                this.user.history.push({ date: Date.now(), amount: amount, game: game });
                if(this.user.history.length > 200) this.user.history.shift();
                this.saveUser();
                this.api.sendTx(amount, game);
                
                if(amount > 0) this.triggerWinFx(amount);
                else if(amount < 0) this.triggerLoseFx(amount);
                
                app.animateBalance(this.user.score);
            },

            triggerWinFx(amount) {
                app.audio.playWin();
                const overlay = $('#fx-overlay');
                overlay.className = 'fx-flash-gold absolute inset-0 z-[9998] flex items-center justify-center';
                const text = document.createElement('div');
                text.className = 'float-text text-gold';
                text.innerText = `+$ ${amount.toLocaleString()}`;
                overlay.appendChild(text);
                this.spawnConfetti();
                setTimeout(() => {
                    overlay.className = 'absolute inset-0 z-[9998] flex items-center justify-center pointer-events-none';
                    if(text.parentNode) text.parentNode.removeChild(text);
                }, 1000);
            },

            triggerLoseFx(amount) {
                app.audio.playLose();
                const appEl = $('#app');
                const overlay = $('#fx-overlay');
                appEl.classList.remove('fx-screen-shake');
                void appEl.offsetWidth; 
                appEl.classList.add('fx-screen-shake');
                overlay.className = 'fx-flash-red absolute inset-0 z-[9998] flex items-center justify-center';
                const text = document.createElement('div');
                text.className = 'float-text text-red-500';
                text.innerText = `$ ${amount.toLocaleString()}`;
                overlay.appendChild(text);
                setTimeout(() => {
                    overlay.className = 'absolute inset-0 z-[9998] flex items-center justify-center pointer-events-none';
                    if(text.parentNode) text.parentNode.removeChild(text);
                    appEl.classList.remove('fx-screen-shake');
                }, 1000);
            },

            spawnConfetti() {
                const colors = ['#D1B27C', '#F8F5EF', '#FFD700', '#FFFFFF'];
                for(let i=0; i<100; i++) {
                    this.particles.push({
                        x: window.innerWidth / 2, y: window.innerHeight / 2,
                        vx: (Math.random() - 0.5) * 15, vy: (Math.random() - 0.5) * 15,
                        size: Math.random() * 8 + 4, color: colors[Math.floor(Math.random()*colors.length)],
                        rotation: Math.random() * 360, rotationSpeed: (Math.random() - 0.5) * 10,
                        life: 1.5, gravity: 0.2
                    });
                }
            },

            animLoop() {
                const ctx = this.fxCtx;
                if(ctx) {
                    ctx.clearRect(0, 0, this.fxCanvas.width, this.fxCanvas.height);
                    for(let i = this.particles.length - 1; i >= 0; i--) {
                        let p = this.particles[i];
                        p.x += p.vx; p.y += p.vy; p.vy += p.gravity || 0; p.vx *= 0.95; 
                        p.rotation += p.rotationSpeed; p.life -= 0.015;
                        if(p.life <= 0) { this.particles.splice(i, 1); continue; }
                        ctx.save(); ctx.translate(p.x, p.y); ctx.rotate(p.rotation * Math.PI / 180);
                        ctx.globalAlpha = p.life; ctx.fillStyle = p.color;
                        ctx.fillRect(-p.size/2, -p.size/2, p.size, p.size); ctx.restore();
                    }
                }
                requestAnimationFrame(() => this.animLoop());
            },

            gotoGame(type) {
                app.audio.playClick();
                if(type === 'taixiu') { this.taixiu.reset(); this.switchView('view-taixiu'); } 
                else if(type === 'blackjack') { this.blackjack.reset(); this.switchView('view-blackjack'); } 
                else if(type === 'slots') { this.slots.reset(); this.switchView('view-slots'); } 
                else if(type === 'trading') { this.switchView('view-trading'); }
            },

            showProfile() {
                app.audio.playClick();
                app.profile.switchTab('bank');
                this.switchView('view-profile');
            },

            showLeaderboard() {
                app.audio.playClick();
                this.leaderboard.switchTab('global');
                this.switchView('view-leaderboard');
            },

            pnl: {
                render() { this.renderChart(); this.renderCalendar(); this.renderStats(); },
                renderChart() {
                    if(app.chartInstance) app.chartInstance.destroy();
                    const ctx = $('#pnlChart').getContext('2d');
                    const startOfDay = new Date(); startOfDay.setHours(0,0,0,0);
                    let running = 0; let todayTotal = 0;
                    const data = [{x: 'Start', y: 0}];
                    app.user.history.forEach(tx => {
                        if(tx.date >= startOfDay.getTime()) {
                            running += tx.amount; todayTotal += tx.amount;
                            data.push({ x: new Date(tx.date).toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'}), y: running });
                        }
                    });
                    $('#pnl-today-val').innerText = (todayTotal>=0?'+':'') + '$ ' + todayTotal.toLocaleString();
                    $('#pnl-today-val').className = `font-mono text-sm ${todayTotal>=0?'text-green-400':'text-red-400'}`;
                    const gradient = ctx.createLinearGradient(0, 0, 0, 200);
                    gradient.addColorStop(0, 'rgba(209, 178, 124, 0.4)'); gradient.addColorStop(1, 'rgba(209, 178, 124, 0)');
                    app.chartInstance = new Chart(ctx, {
                        type: 'line',
                        data: {
                            labels: data.map(d=>d.x),
                            datasets: [{
                                label: 'PNL', data: data.map(d=>d.y), borderColor: '#D1B27C', borderWidth: 2,
                                backgroundColor: gradient, fill: true, pointBackgroundColor: '#F8F5EF', pointBorderColor: '#D1B27C', pointRadius: 3, tension: 0.4 
                            }]
                        },
                        options: {
                            responsive: true, maintainAspectRatio: false,
                            plugins: { legend: {display: false}, tooltip: { mode: 'index', intersect: false } },
                            scales: { x: { display: false }, y: { grid: {color:'rgba(255,255,255,0.05)', drawBorder: false}, ticks: {color:'#666', font: {size: 10}} } },
                            interaction: { mode: 'nearest', axis: 'x', intersect: false }
                        }
                    });
                },
                renderCalendar() {
                    const el = $('#pnl-calendar'); el.innerHTML = '';
                    const daily = {}; const now = new Date();
                    for(let i=29; i>=0; i--) { const d = new Date(now); d.setDate(d.getDate() - i); daily[d.toISOString().split('T')[0]] = 0; }
                    app.user.history.forEach(tx => { const k = new Date(tx.date).toISOString().split('T')[0]; if(daily[k] !== undefined) daily[k] += tx.amount; });
                    Object.keys(daily).sort().forEach(k => {
                        const div = document.createElement('div'); const dayNum = k.split('-')[2]; div.className = 'cal-day';
                        if(k === now.toISOString().split('T')[0]) div.classList.add('today');
                        if(daily[k] > 0) div.classList.add('win'); if(daily[k] < 0) div.classList.add('loss');
                        div.innerText = dayNum; if(daily[k] !== 0) div.title = `${daily[k] > 0 ? '+' : ''}$ ${daily[k].toLocaleString()}`;
                        el.appendChild(div);
                    });
                },
                renderStats() {
                    const wins = (typeof app.user.totalWins === 'number') ? app.user.totalWins : app.user.history.filter(t => t.amount > 0).length;
                    const max = (typeof app.user.bestWin === 'number') ? app.user.bestWin : app.user.history.reduce((m,t) => Math.max(m, t.amount), 0);
                    $('#stat-wins').innerText = wins; $('#stat-max').innerText = '$ ' + max.toLocaleString();
                }
            },
            
            createParticles() {
                const container = $('#particles');
                for(let i=0; i<20; i++) {
                    const p = document.createElement('div');
                    p.className = 'absolute rounded-full bg-gold/20';
                    const size = Math.random() * 3 + 1;
                    p.style.width = size + 'px';
                    p.style.height = size + 'px';
                    p.style.left = Math.random() * 100 + 'vw';
                    p.style.top = Math.random() * 100 + 'vh';
                    p.style.animation = `float ${Math.random()*10 + 10}s infinite linear`;
                    container.appendChild(p);
                }
                const style = document.createElement('style');
                style.innerHTML = `@keyframes float { 0% { transform: translateY(0); opacity:0; } 50% { opacity: 0.5; } 100% { transform: translateY(-100px); opacity: 0; } }`;
                document.head.appendChild(style);
            }
        };

        window.addEventListener('DOMContentLoaded', () => app.init());

    </script>
</body>
</html>
